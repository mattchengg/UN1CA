From d15fb47a378efce3012b2a063ee758559a9f6928 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Sun, 12 Oct 2025 17:58:16 +0200
Subject: [PATCH] Disable MOBILEAP_POWER_SAVEMODE support

UN1CA: this patch is not complete! Please check unica/patches/product_feature/customize.sh for more info.
---
 ...emWifiShellCommand$SqeCommandHandler.smali |   2 +-
 .../server/wifi/ap/SemWifiApChipInfo.smali    |  33 ++--
 ...emWifiApPowerSaveImpl$SoftApCallback.smali |   8 -
 .../wifi/ap/SemWifiApPowerSaveImpl.smali      | 184 +-----------------
 4 files changed, 28 insertions(+), 199 deletions(-)

diff --git a/smali/com/samsung/android/server/wifi/SemWifiShellCommand$SqeCommandHandler.smali b/smali/com/samsung/android/server/wifi/SemWifiShellCommand$SqeCommandHandler.smali
index 9cded28..8ea3e03 100644
--- a/smali/com/samsung/android/server/wifi/SemWifiShellCommand$SqeCommandHandler.smali
+++ b/smali/com/samsung/android/server/wifi/SemWifiShellCommand$SqeCommandHandler.smali
@@ -127,7 +127,7 @@
     return v5
 
     :pswitch_5
-    invoke-virtual {p2, v4}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
+    invoke-virtual {p2, v3}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
     return v5
 
diff --git a/smali/com/samsung/android/server/wifi/ap/SemWifiApChipInfo.smali b/smali/com/samsung/android/server/wifi/ap/SemWifiApChipInfo.smali
index 4e9fa28..943f7cd 100644
--- a/smali/com/samsung/android/server/wifi/ap/SemWifiApChipInfo.smali
+++ b/smali/com/samsung/android/server/wifi/ap/SemWifiApChipInfo.smali
@@ -1318,9 +1318,17 @@
 
     :cond_3
     :goto_0
+    iget-object v2, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->SoftAp_PowerSave:Ljava/lang/String;
+
+    invoke-virtual {v2, v3}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_4
+
     new-instance v2, Ljava/lang/StringBuilder;
 
-    const-string v3, "Support power save mode, SEC_PRODUCT_FEATURE_WLAN_SUPPORT_MOBILEAP_POWER_SAVEMODE : true SoftAp_PowerSave : "
+    const-string v3, "Support power save mode, SEC_PRODUCT_FEATURE_WLAN_SUPPORT_MOBILEAP_POWER_SAVEMODE : false SoftAp_PowerSave : "
 
     invoke-direct {v2, v3}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
 
@@ -1336,11 +1344,12 @@
 
     iput-boolean v5, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->mSupportPowerSave:Z
 
+    :cond_4
     invoke-direct {p0}, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->isKoreaModelForWifiSharingLite()Z
 
     move-result v2
 
-    if-nez v2, :cond_5
+    if-nez v2, :cond_6
 
     sget-object v2, Landroid/os/Build;->MODEL:Ljava/lang/String;
 
@@ -1350,7 +1359,7 @@
 
     move-result v2
 
-    if-nez v2, :cond_4
+    if-nez v2, :cond_5
 
     sget-object v2, Landroid/os/Build;->MODEL:Ljava/lang/String;
 
@@ -1360,9 +1369,9 @@
 
     move-result v2
 
-    if-eqz v2, :cond_5
+    if-eqz v2, :cond_6
 
-    :cond_4
+    :cond_5
     const-string v2, "Disable wifisharing"
 
     invoke-direct {p0, v2}, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->addMHSDumpLog(Ljava/lang/String;)V
@@ -1371,27 +1380,27 @@
 
     sput-boolean v4, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->mSupportWifiSharingLite:Z
 
-    :cond_5
+    :cond_6
     sget-boolean v2, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->mSupportWifiSharingLite:Z
 
     const-string v3, "vendor.wifi.dualconcurrent.interface"
 
-    if-nez v2, :cond_7
+    if-nez v2, :cond_8
 
     sget-boolean v2, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->mSupportWifiSharing:Z
 
-    if-eqz v2, :cond_6
+    if-eqz v2, :cond_7
 
     goto :goto_1
 
-    :cond_6
+    :cond_7
     const-string v2, "wlan0"
 
     invoke-static {v3, v2}, Landroid/os/SystemProperties;->set(Ljava/lang/String;Ljava/lang/String;)V
 
     goto :goto_2
 
-    :cond_7
+    :cond_8
     :goto_1
     const-string v2, "swlan0"
 
@@ -1418,7 +1427,7 @@
 
     const-string v2, " "
 
-    if-eqz v1, :cond_8
+    if-eqz v1, :cond_9
 
     new-instance v1, Ljava/lang/StringBuilder;
 
@@ -1448,7 +1457,7 @@
 
     invoke-direct {p0, v1}, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->addMHSDumpLog(Ljava/lang/String;)V
 
-    :cond_8
+    :cond_9
     new-instance p0, Ljava/lang/StringBuilder;
 
     const-string v1, " checkWifiSharing() "
diff --git a/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback.smali b/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback.smali
index c8cbfd9..a850aef 100644
--- a/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback.smali
+++ b/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback.smali
@@ -40,14 +40,6 @@
     return-void
 .end method
 
-.method synthetic constructor <init>(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;I)V
-    .locals 0
-
-    invoke-direct {p0, p1}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;-><init>(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;)V
-
-    return-void
-.end method
-
 
 # virtual methods
 .method public onConnectedClientsChanged(Landroid/net/wifi/SoftApInfo;Ljava/util/List;)V
diff --git a/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl.smali b/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl.smali
index 6f5174c..bae7e72 100644
--- a/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl.smali
+++ b/smali/com/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl.smali
@@ -6,8 +6,8 @@
 # annotations
 .annotation system Ldalvik/annotation/MemberClasses;
     value = {
-        Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;,
-        Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApPowerSaveStateMachine;
+        Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApPowerSaveStateMachine;,
+        Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;
     }
 .end annotation
 
@@ -94,22 +94,6 @@
 
 
 # direct methods
-.method public static synthetic $r8$lambda$J933CWK8DDQ0tv5oO7y9A487NJ4(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;Z)V
-    .locals 0
-
-    invoke-direct {p0, p1}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->lambda$initializedSemWifiApPowerSaveImpl$0(Z)V
-
-    return-void
-.end method
-
-.method public static synthetic $r8$lambda$_qwirFWtQu9xmsMm8yBNab-wO3Y(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;Z)V
-    .locals 0
-
-    invoke-direct {p0, p1}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->lambda$initializedSemWifiApPowerSaveImpl$1(Z)V
-
-    return-void
-.end method
-
 .method static bridge synthetic -$$Nest$fgetSOFT_AP_SEND_MESSAGE_TIMEOUT_PACKET_CHECK_TAG(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;)Ljava/lang/String;
     .locals 0
 
@@ -932,169 +916,13 @@
 .end method
 
 .method public initializedSemWifiApPowerSaveImpl()V
-    .locals 6
-
-    invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
-
-    move-result-object v0
-
-    invoke-virtual {v0}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiApChipInfo()Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;
-
-    move-result-object v0
-
-    const/4 v1, 0x3
-
-    invoke-virtual {v0, v1}, Lcom/samsung/android/server/wifi/ap/SemWifiApChipInfo;->supportThisSoftApFeature(I)Z
-
-    move-result v0
-
-    const-string v1, "SemWifiApPowerSaveImpl"
-
-    if-nez v0, :cond_0
-
-    const-string p0, "SEC product feature and chip does not support power save mode feature"
-
-    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
-
-    return-void
-
-    :cond_0
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mContext:Landroid/content/Context;
-
-    const-string v2, "wifi"
-
-    invoke-virtual {v0, v2}, Landroid/content/Context;->getSystemService(Ljava/lang/String;)Ljava/lang/Object;
-
-    move-result-object v0
-
-    check-cast v0, Landroid/net/wifi/WifiManager;
-
-    iput-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mWifiManager:Landroid/net/wifi/WifiManager;
-
-    new-instance v0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;
-
-    const/4 v2, 0x0
-
-    invoke-direct {v0, p0, v2}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;-><init>(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;I)V
-
-    iput-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mSoftApCallback:Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;
-
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mWifiManager:Landroid/net/wifi/WifiManager;
-
-    new-instance v3, Landroid/os/HandlerExecutor;
-
-    new-instance v4, Landroid/os/Handler;
-
-    invoke-static {}, Landroid/os/Looper;->getMainLooper()Landroid/os/Looper;
-
-    move-result-object v5
-
-    invoke-direct {v4, v5}, Landroid/os/Handler;-><init>(Landroid/os/Looper;)V
-
-    invoke-direct {v3, v4}, Landroid/os/HandlerExecutor;-><init>(Landroid/os/Handler;)V
-
-    iget-object v4, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mSoftApCallback:Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$SoftApCallback;
-
-    invoke-virtual {v0, v3, v4}, Landroid/net/wifi/WifiManager;->registerSoftApCallback(Ljava/util/concurrent/Executor;Landroid/net/wifi/WifiManager$SoftApCallback;)V
-
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mContext:Landroid/content/Context;
-
-    invoke-virtual {v0}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
-
-    move-result-object v0
-
-    const-string v3, "wifi_ap_powersave_mode_checked"
-
-    invoke-static {v3}, Landroid/provider/Settings$Secure;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
-
-    move-result-object v4
-
-    iget-object v5, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mWifiApPowerSaveImplContentObserver:Landroid/database/ContentObserver;
-
-    invoke-virtual {v0, v4, v2, v5}, Landroid/content/ContentResolver;->registerContentObserver(Landroid/net/Uri;ZLandroid/database/ContentObserver;)V
-
-    invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
-
-    move-result-object v0
-
-    invoke-virtual {v0}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiApServiceImpl()Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
-
-    move-result-object v0
-
-    iput-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mWifiApServiceImpl:Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
-
-    invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
-
-    move-result-object v0
-
-    invoke-virtual {v0}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiApIntentHandler()Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler;
-
-    move-result-object v0
-
-    iput-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->semWifiApIntentHandler:Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler;
-
-    new-instance v2, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$$ExternalSyntheticLambda0;
-
-    invoke-direct {v2, p0}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$$ExternalSyntheticLambda0;-><init>(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;)V
-
-    invoke-virtual {v0, v2}, Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler;->registerListener(Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler$ScreenStateListner;)V
-
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->semWifiApIntentHandler:Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler;
-
-    new-instance v2, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$$ExternalSyntheticLambda1;
-
-    invoke-direct {v2, p0}, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl$$ExternalSyntheticLambda1;-><init>(Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;)V
-
-    invoke-virtual {v0, v2}, Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler;->registerListener(Lcom/samsung/android/server/wifi/ap/SemWifiApIntentHandler$UsbCableStateListner;)V
-
-    invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
-
-    move-result-object v0
-
-    invoke-virtual {v0}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiManagerProxy()Lcom/samsung/android/server/wifi/SemWifiManagerProxy;
-
-    move-result-object v0
-
-    invoke-virtual {v0}, Lcom/samsung/android/server/wifi/SemWifiManagerProxy;->isScreenOn()Z
-
-    move-result v0
-
-    iput-boolean v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mIsLcdOn:Z
-
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mContext:Landroid/content/Context;
-
-    invoke-virtual {v0}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
-
-    move-result-object v0
-
-    const/16 v2, 0xa
-
-    invoke-static {v0, v3, v2}, Landroid/provider/Settings$Secure;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I
-
-    move-result v0
-
-    iput v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mPowerSaveChecked:I
-
-    const/4 v4, 0x1
-
-    if-ne v0, v2, :cond_1
-
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mContext:Landroid/content/Context;
-
-    invoke-virtual {v0}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
-
-    move-result-object v0
-
-    invoke-static {v0, v3, v4}, Landroid/provider/Settings$Secure;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z
-
-    iput v4, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->mPowerSaveChecked:I
+    .locals 1
 
-    :cond_1
-    iput-boolean v4, p0, Lcom/samsung/android/server/wifi/ap/SemWifiApPowerSaveImpl;->isAlreadyInitialized:Z
+    const-string p0, "SemWifiApPowerSaveImpl"
 
-    const-string p0, "initializing SoftAp Power save has been completed"
+    const-string v0, "SEC product feature and chip does not support power save mode feature"
 
-    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {p0, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
     return-void
 .end method
-- 
2.51.0

