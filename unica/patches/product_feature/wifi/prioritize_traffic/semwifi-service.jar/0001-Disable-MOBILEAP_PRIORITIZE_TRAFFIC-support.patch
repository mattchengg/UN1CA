From 7fec9d22f70e3d9b4913592242191d1835f306b7 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Sun, 31 Aug 2025 15:32:19 +0200
Subject: [PATCH] Disable MOBILEAP_PRIORITIZE_TRAFFIC support

UN1CA: this patch is not complete! Please check unica/patches/product_feature/customize.sh for more info.
---
 .../server/wifi/SemWifiManagerProxy.smali     |   2 +-
 .../wifi/ap/SemSettingsSoftResetHandler.smali |  62 +++----
 .../wifi/ap/SemWifiApBroadcastReceiver.smali  | 170 ++++++------------
 3 files changed, 79 insertions(+), 155 deletions(-)

diff --git a/smali/com/samsung/android/server/wifi/SemWifiManagerProxy.smali b/smali/com/samsung/android/server/wifi/SemWifiManagerProxy.smali
index d3d462c..d2c7ec5 100644
--- a/smali/com/samsung/android/server/wifi/SemWifiManagerProxy.smali
+++ b/smali/com/samsung/android/server/wifi/SemWifiManagerProxy.smali
@@ -4482,7 +4482,7 @@
 .method public isWifiApSmartPrioritySupported()Z
     .locals 0
 
-    const/4 p0, 0x1
+    const/4 p0, 0x0
 
     return p0
 .end method
diff --git a/smali/com/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler.smali b/smali/com/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler.smali
index 9c20f2e..7b83b16 100644
--- a/smali/com/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler.smali
+++ b/smali/com/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler.smali
@@ -97,75 +97,61 @@
 .method public resetHotspotSettings()V
     .locals 5
 
-    const-string v0, "disabling traffic priority"
-
-    const-string v1, "SemSettingsSoftResetHandler"
-
-    invoke-static {v1, v0}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
+    sget-object v0, Lcom/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler;->CONFIGOPBRANDINGFORMOBILEAP:Ljava/lang/String;
 
-    iget-object v0, p0, Lcom/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler;->mContext:Landroid/content/Context;
+    const-string v1, "TMO"
 
-    invoke-virtual {v0}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
+    invoke-virtual {v1, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result-object v0
+    move-result v1
 
-    const-string v2, "wifi_ap_smart_priority_enable"
+    const-string v2, "SemSettingsSoftResetHandler"
 
     const/4 v3, 0x0
 
-    invoke-static {v0, v2, v3}, Landroid/provider/Settings$Secure;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z
-
-    sget-object v0, Lcom/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler;->CONFIGOPBRANDINGFORMOBILEAP:Ljava/lang/String;
-
-    const-string v2, "TMO"
+    if-nez v1, :cond_0
 
-    invoke-virtual {v2, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    const-string v1, "NEWCO"
 
-    move-result v2
-
-    if-nez v2, :cond_0
-
-    const-string v2, "NEWCO"
-
-    invoke-virtual {v2, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v1, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v2
+    move-result v1
 
-    if-eqz v2, :cond_1
+    if-eqz v1, :cond_1
 
     :cond_0
-    const-string v2, "disabling autohotspot"
+    const-string v1, "disabling autohotspot"
 
-    invoke-static {v1, v2}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v2, v1}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
 
-    iget-object v2, p0, Lcom/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler;->mContext:Landroid/content/Context;
+    iget-object v1, p0, Lcom/samsung/android/server/wifi/ap/SemSettingsSoftResetHandler;->mContext:Landroid/content/Context;
 
-    invoke-virtual {v2}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
+    invoke-virtual {v1}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
 
-    move-result-object v2
+    move-result-object v1
 
     const-string v4, "wifi_ap_smart_tethering_settings"
 
-    invoke-static {v2, v4, v3}, Landroid/provider/Settings$Secure;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z
+    invoke-static {v1, v4, v3}, Landroid/provider/Settings$Secure;->putInt(Landroid/content/ContentResolver;Ljava/lang/String;I)Z
 
     :cond_1
     invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
 
-    move-result-object v2
+    move-result-object v1
 
-    invoke-virtual {v2}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiManagerProxy()Lcom/samsung/android/server/wifi/SemWifiManagerProxy;
+    invoke-virtual {v1}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getWifiManagerProxy()Lcom/samsung/android/server/wifi/SemWifiManagerProxy;
 
-    move-result-object v2
+    move-result-object v1
 
-    invoke-virtual {v2}, Lcom/samsung/android/server/wifi/SemWifiManagerProxy;->isSemWifiApGuestModeSupported()Z
+    invoke-virtual {v1}, Lcom/samsung/android/server/wifi/SemWifiManagerProxy;->isSemWifiApGuestModeSupported()Z
 
-    move-result v2
+    move-result v1
 
-    if-eqz v2, :cond_2
+    if-eqz v1, :cond_2
 
-    const-string v2, "disabling guest mode also"
+    const-string v1, "disabling guest mode also"
 
-    invoke-static {v1, v2}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v2, v1}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
 
     invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
 
diff --git a/smali/com/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver.smali b/smali/com/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver.smali
index b25435f..9ee40b3 100644
--- a/smali/com/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver.smali
+++ b/smali/com/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver.smali
@@ -939,7 +939,7 @@
 
     move-result v1
 
-    if-eqz v1, :cond_2b
+    if-eqz v1, :cond_28
 
     iget-object v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mWifiApServiceImpl:Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
 
@@ -953,7 +953,7 @@
 
     move-result v1
 
-    if-nez v1, :cond_2b
+    if-nez v1, :cond_28
 
     invoke-static {v12}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
@@ -1031,7 +1031,7 @@
 
     cmp-long v1, v4, v10
 
-    if-nez v1, :cond_2b
+    if-nez v1, :cond_28
 
     invoke-direct {v0}, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->resetParameterForHotspotLogging()V
 
@@ -1099,7 +1099,7 @@
     :goto_3
     invoke-static {v6, v0, v3}, Lcom/samsung/android/server/wifi/SemFrameworkFacade$$ExternalSyntheticOutline0;->m(Ljava/lang/String;Ljava/lang/Exception;Ljava/lang/String;)V
 
-    goto/16 :goto_1b
+    goto/16 :goto_1a
 
     :pswitch_2
     iget-object v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mContext:Landroid/content/Context;
@@ -1108,17 +1108,17 @@
 
     move-result v1
 
-    if-eqz v1, :cond_2b
+    if-eqz v1, :cond_28
 
     invoke-direct {v0}, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->isCtsConnectivityRunning()Z
 
     move-result v1
 
-    if-eqz v1, :cond_2b
+    if-eqz v1, :cond_28
 
     iget-object v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mWifiApServiceImpl:Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
 
-    if-eqz v1, :cond_2b
+    if-eqz v1, :cond_28
 
     const-string v1, "Force set provision true for cts when com.google.snippet.connectivity - ConnectivityMultiDevicesSnippet"
 
@@ -1196,15 +1196,15 @@
 
     invoke-static {v3, v6, v2}, Lcom/samsung/android/server/wifi/SemWifiCoexManager$SoftApCallback$$ExternalSyntheticOutline0;->m(Ljava/lang/String;ILjava/lang/StringBuilder;)V
 
-    if-eqz v1, :cond_2b
+    if-eqz v1, :cond_28
 
     iget v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mMaxClientNum:I
 
-    if-ltz v1, :cond_2b
+    if-ltz v1, :cond_28
 
     const/16 v2, 0xa
 
-    if-gt v1, v2, :cond_2b
+    if-gt v1, v2, :cond_28
 
     invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
 
@@ -1424,13 +1424,13 @@
 
     move-result-object v10
 
-    if-eqz v10, :cond_2b
+    if-eqz v10, :cond_28
 
     invoke-virtual {v10}, Landroid/net/wifi/SoftApConfiguration;->getSsid()Ljava/lang/String;
 
     move-result-object v11
 
-    if-eqz v11, :cond_2b
+    if-eqz v11, :cond_28
 
     invoke-virtual {v10}, Landroid/net/wifi/SoftApConfiguration;->getChannels()Landroid/util/SparseIntArray;
 
@@ -1786,9 +1786,9 @@
 
     invoke-static {v3, v14}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
-    iget-object v14, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mSemSoftApManager:Lcom/samsung/android/server/wifi/ap/SemSoftApManager;
+    iget-object v3, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mSemSoftApManager:Lcom/samsung/android/server/wifi/ap/SemSoftApManager;
 
-    invoke-virtual {v14}, Lcom/samsung/android/server/wifi/ap/SemSoftApManager;->setIsGuestClientConnectedFalse()V
+    invoke-virtual {v3}, Lcom/samsung/android/server/wifi/ap/SemSoftApManager;->setIsGuestClientConnectedFalse()V
 
     goto :goto_13
 
@@ -1796,74 +1796,6 @@
     move-object/from16 v13, p3
 
     :goto_13
-    new-instance v14, Ljava/lang/StringBuilder;
-
-    invoke-direct {v14}, Ljava/lang/StringBuilder;-><init>()V
-
-    invoke-virtual {v14, v10}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    invoke-virtual {v14, v12}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    invoke-virtual {v14, v13}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    invoke-virtual {v14}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
-
-    move-result-object v10
-
-    invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
-
-    move-result-object v13
-
-    invoke-virtual {v13}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getSemWifiApTrafficPriority()Lcom/samsung/android/server/wifi/ap/smartprio/SemWifiApTrafficPriority;
-
-    move-result-object v13
-
-    if-eqz v13, :cond_22
-
-    invoke-virtual {v13}, Lcom/samsung/android/server/wifi/ap/smartprio/SemWifiApTrafficPriority;->getmIsPriorityFeatureEnableDuringSession()Z
-
-    move-result v14
-
-    if-eqz v14, :cond_22
-
-    invoke-virtual {v13}, Lcom/samsung/android/server/wifi/ap/smartprio/SemWifiApTrafficPriority;->getNRTTrafficEnable()Z
-
-    move-result v14
-
-    if-eqz v14, :cond_21
-
-    invoke-virtual {v13}, Lcom/samsung/android/server/wifi/ap/smartprio/SemWifiApTrafficPriority;->getRTTrafficEnable()Z
-
-    move-result v13
-
-    if-eqz v13, :cond_20
-
-    const-string v13, "tp_rt"
-
-    goto :goto_14
-
-    :cond_20
-    const-string v13, "tp_nrt"
-
-    goto :goto_14
-
-    :cond_21
-    const-string v13, "tp_on_below_cutoff"
-
-    goto :goto_14
-
-    :cond_22
-    const-string v13, "tp_off"
-
-    :goto_14
-    const-string v14, "handleWifiApState: "
-
-    invoke-virtual {v14, v13}, Ljava/lang/String;->concat(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v14
-
-    invoke-static {v3, v14}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
-
     new-instance v3, Ljava/lang/StringBuilder;
 
     invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
@@ -1878,13 +1810,19 @@
 
     move-result-object v3
 
+    const-string v10, "-not_support"
+
+    invoke-static {v3, v10}, Lcom/samsung/android/server/wifi/SemClientModeImpl$$ExternalSyntheticOutline0;->m(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v3
+
     invoke-static {}, Lcom/samsung/android/server/wifi/ap/SemWifiApUtils;->getOneUiVersion()I
 
     move-result v10
 
     const v13, 0xea60
 
-    if-lt v10, v13, :cond_25
+    if-lt v10, v13, :cond_22
 
     invoke-static {}, Lcom/samsung/android/server/wifi/SemWifiInjector;->getInstance()Lcom/samsung/android/server/wifi/SemWifiInjector;
 
@@ -1900,33 +1838,33 @@
 
     const/4 v14, 0x1
 
-    if-eq v13, v14, :cond_24
+    if-eq v13, v14, :cond_21
 
     const/4 v14, 0x2
 
-    if-eq v13, v14, :cond_23
+    if-eq v13, v14, :cond_20
 
     const-string v13, "unknown"
 
-    goto :goto_15
+    goto :goto_14
 
-    :cond_23
+    :cond_20
     const-string v13, "lock_off"
 
-    goto :goto_15
+    goto :goto_14
 
-    :cond_24
+    :cond_21
     const-string v13, "lock_on"
 
-    :goto_15
+    :goto_14
     invoke-virtual {v10}, Lcom/samsung/android/server/wifi/ap/SemWifiApLockManager;->setmSessionLockState()V
 
-    goto :goto_16
+    goto :goto_15
 
-    :cond_25
+    :cond_22
     const-string v13, "Not_supported"
 
-    :goto_16
+    :goto_15
     new-instance v10, Ljava/lang/StringBuilder;
 
     invoke-direct {v10}, Ljava/lang/StringBuilder;-><init>()V
@@ -2017,7 +1955,7 @@
 
     iget-object v0, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mWifiApServiceImpl:Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
 
-    if-eqz v0, :cond_2b
+    if-eqz v0, :cond_28
 
     const-string v2, "MHSI"
 
@@ -2031,7 +1969,7 @@
 
     cmp-long v1, v4, v10
 
-    if-eqz v1, :cond_2a
+    if-eqz v1, :cond_27
 
     invoke-static {}, Ljava/lang/System;->currentTimeMillis()J
 
@@ -2049,7 +1987,7 @@
     :try_end_1
     .catch Ljava/lang/Exception; {:try_start_1 .. :try_end_1} :catch_3
 
-    if-eqz v1, :cond_26
+    if-eqz v1, :cond_23
 
     move-wide/from16 p3, v10
 
@@ -2100,16 +2038,16 @@
     :try_end_2
     .catch Ljava/lang/Exception; {:try_start_2 .. :try_end_2} :catch_1
 
-    goto :goto_17
+    goto :goto_16
 
     :catch_1
     move-exception v0
 
     move-object v1, v6
 
-    goto/16 :goto_1a
+    goto/16 :goto_19
 
-    :cond_26
+    :cond_23
     move-wide/from16 v16, v8
 
     move-wide/from16 p3, v10
@@ -2119,7 +2057,7 @@
     :try_start_3
     iget-wide v10, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mAmountTimeOfMobileData:J
 
-    :goto_17
+    :goto_16
     invoke-static {v9}, Landroid/net/TrafficStats;->getTxBytes(Ljava/lang/String;)J
 
     move-result-wide v1
@@ -2172,7 +2110,7 @@
 
     cmp-long v18, v1, p3
 
-    if-ltz v18, :cond_27
+    if-ltz v18, :cond_24
 
     move-object/from16 p3, v6
 
@@ -2255,36 +2193,36 @@
 
     move-result-object v7
 
-    goto :goto_19
+    goto :goto_18
 
     :catch_2
     move-exception v0
 
-    :goto_18
+    :goto_17
     move-object/from16 v1, p3
 
-    goto :goto_1a
+    goto :goto_19
 
-    :cond_27
+    :cond_24
     move-object/from16 p3, v6
 
     const/4 v7, 0x0
 
-    :goto_19
-    if-eqz v7, :cond_28
+    :goto_18
+    if-eqz v7, :cond_25
 
     iget-object v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mWifiApServiceImpl:Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;
 
-    if-eqz v1, :cond_28
+    if-eqz v1, :cond_25
 
     const-string v2, "MHSS"
 
     invoke-virtual {v1, v2, v7}, Lcom/samsung/android/server/wifi/ap/SemWifiApServiceImpl;->reportBigData(Ljava/lang/String;Ljava/lang/String;)V
 
-    :cond_28
+    :cond_25
     iget-object v1, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mTelephonyPhoneStateListener:Landroid/telephony/PhoneStateListener;
 
-    if-eqz v1, :cond_29
+    if-eqz v1, :cond_26
 
     iget-object v2, v0, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->mTelephonyManagerForHotspot:Landroid/telephony/TelephonyManager;
 
@@ -2292,7 +2230,7 @@
 
     invoke-virtual {v2, v1, v4}, Landroid/telephony/TelephonyManager;->listen(Landroid/telephony/PhoneStateListener;I)V
 
-    :cond_29
+    :cond_26
     invoke-direct {v0}, Lcom/samsung/android/server/wifi/ap/SemWifiApBroadcastReceiver;->resetParameterForHotspotLogging()V
 
     return-void
@@ -2302,9 +2240,9 @@
 
     move-object/from16 p3, v6
 
-    goto :goto_18
+    goto :goto_17
 
-    :cond_2a
+    :cond_27
     move-object/from16 p3, v6
 
     const-string v0, "unnormal status of interface"
@@ -2315,11 +2253,11 @@
 
     return-void
 
-    :goto_1a
+    :goto_19
     invoke-static {v1, v0, v3}, Lcom/samsung/android/server/wifi/SemFrameworkFacade$$ExternalSyntheticOutline0;->m(Ljava/lang/String;Ljava/lang/Exception;Ljava/lang/String;)V
 
-    :cond_2b
-    :goto_1b
+    :cond_28
+    :goto_1a
     return-void
 
     nop
-- 
2.51.0

