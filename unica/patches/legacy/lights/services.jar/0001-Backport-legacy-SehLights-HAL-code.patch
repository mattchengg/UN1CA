From 21aa31901151697c6ae7421acd2fea5b3216d783 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Tue, 26 Aug 2025 22:55:05 +0200
Subject: [PATCH] Backport legacy SehLights HAL code

---
 ...LocalDisplayAdapter$BacklightAdapter.smali |  94 +++--
 .../lights/LightsService$LightImpl.smali      | 325 +++++++++++-------
 .../server/power/PowerManagerUtil.smali       |  28 +-
 .../light/ISehLights$Stub$Proxy.smali         |   6 +-
 4 files changed, 282 insertions(+), 171 deletions(-)

diff --git a/smali/com/android/server/display/LocalDisplayAdapter$BacklightAdapter.smali b/smali/com/android/server/display/LocalDisplayAdapter$BacklightAdapter.smali
index cb90d9e5..9e5b39c7 100644
--- a/smali/com/android/server/display/LocalDisplayAdapter$BacklightAdapter.smali
+++ b/smali/com/android/server/display/LocalDisplayAdapter$BacklightAdapter.smali
@@ -111,22 +111,22 @@
 
 # virtual methods
 .method public final setBacklight(FFFFII)V
-    .locals 3
+    .locals 6
 
     iget-boolean v0, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mUseSurfaceControlBrightness:Z
 
-    if-nez v0, :cond_4
+    if-nez v0, :cond_6
 
     iget-boolean v0, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mForceSurfaceControl:Z
 
     if-eqz v0, :cond_0
 
-    goto :goto_0
+    goto :goto_2
 
     :cond_0
     iget-object p0, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mBacklight:Lcom/android/server/lights/LightsService$LightImpl;
 
-    if-eqz p0, :cond_3
+    if-eqz p0, :cond_5
 
     invoke-static {p3}, Ljava/lang/Float;->isNaN(F)Z
 
@@ -156,14 +156,12 @@
     monitor-enter p0
 
     :try_start_0
+    move/from16 v0, p3
+
     invoke-static {p3}, Lcom/android/internal/display/BrightnessSynchronizer;->brightnessFloatToInt(F)I
 
     move-result p1
 
-    const/16 p2, 0xff
-
-    if-gt p1, p2, :cond_2
-
     and-int/lit16 p1, p1, 0xff
 
     shl-int/lit8 p2, p1, 0x10
@@ -178,6 +176,18 @@
 
     or-int/2addr p1, p2
 
+    iget-object p2, p0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
+
+    iget-byte p2, p2, Landroid/hardware/light/HwLight;->type:B
+
+    if-eqz p2, :cond_3
+
+    const/16 v0, 0x9
+
+    if-ne p2, v0, :cond_2
+
+    goto :goto_0
+
     :cond_2
     const/4 p2, 0x0
 
@@ -187,6 +197,48 @@
 
     return-void
 
+    :cond_3
+    :goto_0
+    const/high16 p2, 0x437f0000    # 255.0f
+
+    mul-float/2addr v0, p2
+
+    sget-boolean p2, Lcom/android/server/power/PowerManagerUtil;->USE_PERSONAL_AUTO_BRIGHTNESS_V3:Z
+
+    if-eqz p2, :cond_4
+
+    const/16 p2, 0x64
+
+    goto :goto_1
+
+    :cond_4
+    const/4 p2, 0x1
+
+    :goto_1
+    int-to-float p2, p2
+
+    mul-float/2addr v0, p2
+
+    invoke-static {v0}, Ljava/lang/Math;->round(F)I
+
+    move-result v2
+
+    const/4 v3, 0x0
+
+    const/4 v4, 0x0
+
+    const/4 v5, 0x0
+
+    move-object v0, p0
+
+    move v1, p1
+
+    invoke-virtual/range {v0 .. v5}, Lcom/android/server/lights/LightsService$LightImpl;->setLightLocked(IIIII)V
+
+    monitor-exit p0
+
+    return-void
+
     :catchall_0
     move-exception p1
 
@@ -196,18 +248,18 @@
 
     throw p1
 
-    :cond_3
+    :cond_5
     return-void
 
-    :cond_4
-    :goto_0
+    :cond_6
+    :goto_2
     const/high16 v0, 0x7fc00000    # Float.NaN
 
     invoke-static {p1, v0}, Lcom/android/internal/display/BrightnessSynchronizer;->floatEquals(FF)Z
 
     move-result v0
 
-    if-eqz v0, :cond_5
+    if-eqz v0, :cond_7
 
     iget-object p1, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mSurfaceControlProxy:Lcom/android/server/display/LocalDisplayAdapter$SurfaceControlProxy;
 
@@ -219,7 +271,7 @@
 
     return-void
 
-    :cond_5
+    :cond_7
     const-string/jumbo v0, "LocalDisplayAdapter"
 
     new-instance v1, Ljava/lang/StringBuilder;
@@ -250,16 +302,16 @@
 
     iget-boolean v2, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mIsFirstDisplay:Z
 
-    if-eqz v2, :cond_6
+    if-eqz v2, :cond_8
 
     const-string/jumbo v2, "main"
 
-    goto :goto_1
+    goto :goto_3
 
-    :cond_6
+    :cond_8
     const-string/jumbo v2, "sub"
 
-    :goto_1
+    :goto_3
     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     const-string v2, " +"
@@ -310,16 +362,16 @@
 
     iget-boolean p0, p0, Lcom/android/server/display/LocalDisplayAdapter$BacklightAdapter;->mIsFirstDisplay:Z
 
-    if-eqz p0, :cond_7
+    if-eqz p0, :cond_9
 
     const-string/jumbo p0, "main"
 
-    goto :goto_2
+    goto :goto_4
 
-    :cond_7
+    :cond_9
     const-string/jumbo p0, "sub"
 
-    :goto_2
+    :goto_4
     invoke-virtual {p4, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     const-string p0, " -"
diff --git a/smali/com/android/server/lights/LightsService$LightImpl.smali b/smali/com/android/server/lights/LightsService$LightImpl.smali
index 2c889d61..588ccc02 100644
--- a/smali/com/android/server/lights/LightsService$LightImpl.smali
+++ b/smali/com/android/server/lights/LightsService$LightImpl.smali
@@ -384,257 +384,334 @@
 .end method
 
 .method public final setLightLocked(IIII)V
+    .locals 6
+
+    const/4 v2, -0x1
+
+    move-object v0, p0
+
+    move v1, p1
+
+    move v3, p2
+
+    move v4, p3
+
+    move v5, p4
+
+    invoke-virtual/range {v0 .. v5}, Lcom/android/server/lights/LightsService$LightImpl;->setLightLocked(IIIII)V
+
+    return-void
+.end method
+
+.method public final setLightLocked(IIIII)V
     .locals 11
 
-    iget-boolean v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mInitialized:Z
+    move-object v0, p0
 
-    iget-object v1, p0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
+    move v1, p1
 
-    if-eqz v0, :cond_0
+    move v2, p3
 
-    iget v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mColor:I
+    move v3, p4
 
-    if-ne p1, v0, :cond_0
+    move/from16 v4, p5
 
-    iget v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mMode:I
+    iget-boolean v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mInitialized:Z
 
-    if-ne p2, v0, :cond_0
+    if-eqz v5, :cond_0
 
-    iget v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mOnMS:I
+    iget v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mColor:I
 
-    if-ne p3, v0, :cond_0
+    if-ne v1, v5, :cond_0
 
-    iget v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mOffMS:I
+    iget v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mMode:I
 
-    if-ne p4, v0, :cond_0
+    if-ne v2, v5, :cond_0
 
-    iget-boolean v0, v1, Lcom/android/server/lights/LightsService;->mIsLEDChanged:Z
+    iget v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mOnMS:I
 
-    if-eqz v0, :cond_5
+    if-ne v3, v5, :cond_0
+
+    iget v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mOffMS:I
+
+    if-ne v4, v5, :cond_0
+
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
+
+    iget-boolean v5, v5, Lcom/android/server/lights/LightsService;->mIsLEDChanged:Z
+
+    if-eqz v5, :cond_4
 
     :cond_0
-    const/4 v0, 0x0
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
+
+    const/4 v6, 0x0
 
-    iput-boolean v0, v1, Lcom/android/server/lights/LightsService;->mIsLEDChanged:Z
+    iput-boolean v6, v5, Lcom/android/server/lights/LightsService;->mIsLEDChanged:Z
 
-    const/4 v0, 0x1
+    const/4 v5, 0x1
 
-    iput-boolean v0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mInitialized:Z
+    iput-boolean v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mInitialized:Z
 
-    iput p1, p0, Lcom/android/server/lights/LightsService$LightImpl;->mColor:I
+    iput v1, v0, Lcom/android/server/lights/LightsService$LightImpl;->mColor:I
 
-    iput p2, p0, Lcom/android/server/lights/LightsService$LightImpl;->mMode:I
+    iput v2, v0, Lcom/android/server/lights/LightsService$LightImpl;->mMode:I
 
-    iput p3, p0, Lcom/android/server/lights/LightsService$LightImpl;->mOnMS:I
+    iput v3, v0, Lcom/android/server/lights/LightsService$LightImpl;->mOnMS:I
 
-    iput p4, p0, Lcom/android/server/lights/LightsService$LightImpl;->mOffMS:I
+    iput v4, v0, Lcom/android/server/lights/LightsService$LightImpl;->mOffMS:I
 
-    iget-object p0, p0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    iget-byte v0, p0, Landroid/hardware/light/HwLight;->type:B
+    iget-byte v5, v5, Landroid/hardware/light/HwLight;->type:B
 
-    const-string/jumbo v2, "LightsService"
+    const-string v7, "LightsService"
 
-    if-eqz v0, :cond_1
+    if-eqz v5, :cond_1
 
-    const/16 v3, 0x9
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    if-eq v0, v3, :cond_1
+    iget-byte v5, v5, Landroid/hardware/light/HwLight;->type:B
 
-    new-instance v0, Ljava/lang/StringBuilder;
+    const/16 v8, 0x9
 
-    const-string/jumbo v3, "[SvcLED] [setLightLocked] lightType:"
+    if-eq v5, v8, :cond_1
 
-    invoke-direct {v0, v3}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+    new-instance v5, Ljava/lang/StringBuilder;
 
-    iget-byte v3, p0, Landroid/hardware/light/HwLight;->type:B
+    const-string v8, "[SvcLED] [setLightLocked] lightType:"
 
-    invoke-static {v3}, Lcom/android/server/lights/LightsService;->translateLightType(I)Ljava/lang/String;
+    invoke-direct {v5, v8}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
 
-    move-result-object v3
+    iget-object v8, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    iget-byte v8, v8, Landroid/hardware/light/HwLight;->type:B
 
-    const-string v3, ", color:"
+    invoke-static {v8}, Lcom/android/server/lights/LightsService;->translateLightType(I)Ljava/lang/String;
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move-result-object v8
 
-    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const-string v3, ", mode: "
+    move-result-object v5
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    const-string v8, ", color:"
 
-    const-string v3, ", onMS: "
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const-string v4, ", offMS: "
+    move-result-object v5
 
-    invoke-static {p2, p3, v3, v4, v0}, Lcom/android/server/ServiceKeeper$$ExternalSyntheticOutline0;->m(IILjava/lang/String;Ljava/lang/String;Ljava/lang/StringBuilder;)V
+    invoke-virtual {v5, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-static {v0, p4, v2}, Lcom/android/server/BatteryService$$ExternalSyntheticOutline0;->m(Ljava/lang/StringBuilder;ILjava/lang/String;)V
+    move-result-object v5
+
+    const-string v8, ", mode: "
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    const-string v8, ", onMS: "
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5, p4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    const-string v8, ", offMS: "
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5, v4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-static {v7, v5}, Lcom/android/server/power/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
 
     :cond_1
-    new-instance v0, Ljava/lang/StringBuilder;
+    new-instance v5, Ljava/lang/StringBuilder;
 
-    const-string/jumbo v3, "setLightState("
+    const-string v8, "setLightState("
 
-    invoke-direct {v0, v3}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
+    invoke-direct {v5, v8}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
 
-    iget v3, p0, Landroid/hardware/light/HwLight;->id:I
+    iget-object v8, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    iget v8, v8, Landroid/hardware/light/HwLight;->id:I
 
-    const-string v3, ", 0x"
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move-result-object v5
+
+    const-string v8, ", 0x"
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
 
     invoke-static {p1}, Ljava/lang/Integer;->toHexString(I)Ljava/lang/String;
 
-    move-result-object v3
+    move-result-object v8
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const-string v3, ")"
+    move-result-object v5
 
-    invoke-virtual {v0, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    const-string v8, ")"
 
-    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-result-object v0
+    move-result-object v5
 
-    const-wide/32 v3, 0x20000
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    invoke-static {v3, v4, v0}, Landroid/os/Trace;->traceBegin(JLjava/lang/String;)V
+    move-result-object v5
 
-    :try_start_0
-    iget-object v0, v1, Lcom/android/server/lights/LightsService;->mVintfLights:Ljava/util/function/Supplier;
+    const-wide/32 v8, 0x20000
 
-    const/4 v10, 0x0
+    invoke-static {v8, v9, v5}, Landroid/os/Trace;->traceBegin(JLjava/lang/String;)V
 
-    if-nez v0, :cond_2
+    :try_start_0
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
 
-    iget-object v0, v1, Lcom/android/server/lights/LightsService;->mVintfSehLights:Ljava/util/function/Supplier;
+    iget-object v5, v5, Lcom/android/server/lights/LightsService;->mVintfLights:Ljava/util/function/Supplier;
 
-    if-eqz v0, :cond_3
+    if-nez v5, :cond_2
 
-    :cond_2
-    move v6, p1
+    iget-object v5, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
 
-    move v7, p2
+    iget-object v5, v5, Lcom/android/server/lights/LightsService;->mVintfSehLights:Ljava/util/function/Supplier;
 
-    move v8, p3
+    if-nez v5, :cond_2
 
-    move v9, p4
+    iget-object v0, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    goto :goto_0
+    iget v0, v0, Landroid/hardware/light/HwLight;->id:I
 
-    :cond_3
-    iget v5, p0, Landroid/hardware/light/HwLight;->id:I
+    const/4 v5, 0x0
 
-    move v6, p1
+    move v1, p1
 
-    move v7, p2
+    move v2, p3
 
-    move v8, p3
+    move v3, p4
 
-    move v9, p4
+    move/from16 v4, p5
 
-    invoke-static/range {v5 .. v10}, Lcom/android/server/lights/LightsService;->setLight_native(IIIIII)V
+    invoke-static/range {v0 .. v5}, Lcom/android/server/lights/LightsService;->setLight_native(IIIIII)V
 
-    goto :goto_1
+    goto :goto_0
 
-    :catchall_0
-    move-exception v0
+    :cond_2
+    new-instance v5, Landroid/hardware/light/HwLightState;
 
-    move-object p0, v0
+    const/4 v10, 0x0
 
-    goto :goto_3
+    invoke-direct {v5}, Landroid/hardware/light/HwLightState;-><init>()V
 
-    :catch_0
-    move-exception v0
+    iput v1, v5, Landroid/hardware/light/HwLightState;->color:I
 
-    move-object p0, v0
+    int-to-byte v1, v2
 
-    goto :goto_2
+    iput-byte v1, v5, Landroid/hardware/light/HwLightState;->flashMode:B
 
-    :goto_0
-    new-instance p1, Landroid/hardware/light/HwLightState;
+    iput v3, v5, Landroid/hardware/light/HwLightState;->flashOnMs:I
 
-    invoke-direct {p1}, Landroid/hardware/light/HwLightState;-><init>()V
+    iput v4, v5, Landroid/hardware/light/HwLightState;->flashOffMs:I
 
-    iput v6, p1, Landroid/hardware/light/HwLightState;->color:I
+    iput-byte v6, v5, Landroid/hardware/light/HwLightState;->brightnessMode:B
 
-    int-to-byte p2, v7
+    iget-object v1, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
 
-    iput-byte p2, p1, Landroid/hardware/light/HwLightState;->flashMode:B
+    iget-object v1, v1, Lcom/android/server/lights/LightsService;->mVintfLights:Ljava/util/function/Supplier;
 
-    iput v8, p1, Landroid/hardware/light/HwLightState;->flashOnMs:I
+    if-eqz v1, :cond_3
 
-    iput v9, p1, Landroid/hardware/light/HwLightState;->flashOffMs:I
+    iget-object v1, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
 
-    int-to-byte p2, v10
+    iget-object v1, v1, Lcom/android/server/lights/LightsService;->mVintfLights:Ljava/util/function/Supplier;
 
-    iput-byte p2, p1, Landroid/hardware/light/HwLightState;->brightnessMode:B
+    invoke-interface {v1}, Ljava/util/function/Supplier;->get()Ljava/lang/Object;
 
-    iget-object p2, v1, Lcom/android/server/lights/LightsService;->mVintfLights:Ljava/util/function/Supplier;
+    move-result-object v1
 
-    if-eqz p2, :cond_4
+    check-cast v1, Landroid/hardware/light/ILights;
 
-    invoke-interface {p2}, Ljava/util/function/Supplier;->get()Ljava/lang/Object;
+    iget-object v0, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    move-result-object p2
+    iget v0, v0, Landroid/hardware/light/HwLight;->id:I
 
-    check-cast p2, Landroid/hardware/light/ILights;
+    check-cast v1, Landroid/hardware/light/ILights$Stub$Proxy;
 
-    iget p0, p0, Landroid/hardware/light/HwLight;->id:I
+    invoke-virtual {v1, v0, v5}, Landroid/hardware/light/ILights$Stub$Proxy;->setLightState(ILandroid/hardware/light/HwLightState;)V
 
-    check-cast p2, Landroid/hardware/light/ILights$Stub$Proxy;
+    goto :goto_0
 
-    invoke-virtual {p2, p0, p1}, Landroid/hardware/light/ILights$Stub$Proxy;->setLightState(ILandroid/hardware/light/HwLightState;)V
+    :cond_3
+    iget-object v1, v0, Lcom/android/server/lights/LightsService$LightImpl;->this$0:Lcom/android/server/lights/LightsService;
 
-    goto :goto_1
+    iget-object v1, v1, Lcom/android/server/lights/LightsService;->mVintfSehLights:Ljava/util/function/Supplier;
 
-    :cond_4
-    iget-object p2, v1, Lcom/android/server/lights/LightsService;->mVintfSehLights:Ljava/util/function/Supplier;
+    invoke-interface {v1}, Ljava/util/function/Supplier;->get()Ljava/lang/Object;
+
+    move-result-object v1
 
-    invoke-interface {p2}, Ljava/util/function/Supplier;->get()Ljava/lang/Object;
+    check-cast v1, Lvendor/samsung/hardware/light/ISehLights;
 
-    move-result-object p2
+    iget-object v0, v0, Lcom/android/server/lights/LightsService$LightImpl;->mHwLight:Landroid/hardware/light/HwLight;
 
-    check-cast p2, Lvendor/samsung/hardware/light/ISehLights;
+    iget v0, v0, Landroid/hardware/light/HwLight;->id:I
 
-    iget p0, p0, Landroid/hardware/light/HwLight;->id:I
+    move v2, p2
 
-    check-cast p2, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;
+    check-cast v1, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;
 
-    invoke-virtual {p2, p0, p1}, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;->setLightState(ILandroid/hardware/light/HwLightState;)V
+    invoke-virtual {v1, v0, v5, p2}, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;->setLightState(ILandroid/hardware/light/HwLightState;I)V
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
     .catch Ljava/lang/UnsupportedOperationException; {:try_start_0 .. :try_end_0} :catch_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    :goto_1
-    invoke-static {v3, v4}, Landroid/os/Trace;->traceEnd(J)V
+    goto :goto_0
 
-    return-void
+    :catchall_0
+    move-exception v0
+
+    goto :goto_1
+
+    :catch_0
+    move-exception v0
 
-    :goto_2
     :try_start_1
-    const-string p1, "Failed issuing setLightState"
+    const-string v1, "Failed issuing setLightState"
 
-    invoke-static {v2, p1, p0}, Lcom/android/server/power/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)V
+    invoke-static {v7, v1, v0}, Lcom/android/server/power/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
-    invoke-static {v3, v4}, Landroid/os/Trace;->traceEnd(J)V
+    :goto_0
+    invoke-static {v8, v9}, Landroid/os/Trace;->traceEnd(J)V
 
-    :cond_5
+    :cond_4
     return-void
 
-    :goto_3
-    invoke-static {v3, v4}, Landroid/os/Trace;->traceEnd(J)V
+    :goto_1
+    invoke-static {v8, v9}, Landroid/os/Trace;->traceEnd(J)V
 
-    throw p0
+    throw v0
 .end method
 
 .method public final turnOff()V
diff --git a/smali_classes2/com/android/server/power/PowerManagerUtil.smali b/smali_classes2/com/android/server/power/PowerManagerUtil.smali
index 439d808f..556013ec 100644
--- a/smali_classes2/com/android/server/power/PowerManagerUtil.smali
+++ b/smali_classes2/com/android/server/power/PowerManagerUtil.smali
@@ -1020,23 +1020,7 @@
     :goto_1b
     sput-boolean v16, Lcom/android/server/power/PowerManagerUtil;->SEC_FEATURE_SUPPORT_LEGACY_MISC_POWER_HAL:Z
 
-    if-eqz v10, :cond_1d
-
-    invoke-static {v8, v0}, Landroid/os/SystemProperties;->getInt(Ljava/lang/String;I)I
-
-    move-result v3
-
-    if-ge v3, v1, :cond_1d
-
-    move/from16 v16, v2
-
-    goto :goto_1c
-
-    :cond_1d
-    move/from16 v16, v0
-
-    :goto_1c
-    sput-boolean v16, Lcom/android/server/power/PowerManagerUtil;->SEC_FEATURE_USE_LIGHTS_HAL_EXTENSION:Z
+    sput-boolean v2, Lcom/android/server/power/PowerManagerUtil;->SEC_FEATURE_USE_LIGHTS_HAL_EXTENSION:Z
 
     const-string v1, "-1"
 
@@ -1046,7 +1030,7 @@
 
     sput v1, Lcom/android/server/power/PowerManagerUtil;->LCD_FLASH_BRIGHTNESS:I
 
-    if-eqz v9, :cond_1e
+    if-eqz v9, :cond_1d
 
     invoke-static {v8, v0}, Landroid/os/SystemProperties;->getInt(Ljava/lang/String;I)I
 
@@ -1054,16 +1038,16 @@
 
     const/16 v0, 0x23
 
-    if-lt v1, v0, :cond_1e
+    if-lt v1, v0, :cond_1d
 
     move v0, v2
 
-    goto :goto_1d
+    goto :goto_1c
 
-    :cond_1e
+    :cond_1d
     const/4 v0, 0x0
 
-    :goto_1d
+    :goto_1c
     sput-boolean v0, Lcom/android/server/power/PowerManagerUtil;->SEC_FEATURE_DISPLAY_STATE_CONCURRENCY:Z
 
     sput-boolean v2, Lcom/android/server/power/PowerManagerUtil;->USE_SEC_LONG_TERM_MODEL:Z
diff --git a/smali_classes2/vendor/samsung/hardware/light/ISehLights$Stub$Proxy.smali b/smali_classes2/vendor/samsung/hardware/light/ISehLights$Stub$Proxy.smali
index 9d742220..f1440a7d 100644
--- a/smali_classes2/vendor/samsung/hardware/light/ISehLights$Stub$Proxy.smali
+++ b/smali_classes2/vendor/samsung/hardware/light/ISehLights$Stub$Proxy.smali
@@ -92,7 +92,7 @@
     throw p0
 .end method
 
-.method public final setLightState(ILandroid/hardware/light/HwLightState;)V
+.method public final setLightState(ILandroid/hardware/light/HwLightState;I)V
     .locals 3
 
     iget-object v0, p0, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;->mRemote:Landroid/os/IBinder;
@@ -116,9 +116,7 @@
 
     invoke-virtual {v0, p2, p1}, Landroid/os/Parcel;->writeTypedObject(Landroid/os/Parcelable;I)V
 
-    const/4 p2, -0x1
-
-    invoke-virtual {v0, p2}, Landroid/os/Parcel;->writeInt(I)V
+    invoke-virtual {v0, p3}, Landroid/os/Parcel;->writeInt(I)V
 
     iget-object p0, p0, Lvendor/samsung/hardware/light/ISehLights$Stub$Proxy;->mRemote:Landroid/os/IBinder;
 
-- 
2.51.0

