From f9e82b01f0cb31c4255d56a294e5f374bf70259b Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Thu, 30 Oct 2025 13:29:50 +0100
Subject: [PATCH] Backport legacy UiccController code

---
 .../telephony/uicc/UiccController.smali       | 97 +++++++++++++++----
 1 file changed, 77 insertions(+), 20 deletions(-)

diff --git a/smali/com/android/internal/telephony/uicc/UiccController.smali b/smali/com/android/internal/telephony/uicc/UiccController.smali
index 4d2a7d0..2ce48fd 100644
--- a/smali/com/android/internal/telephony/uicc/UiccController.smali
+++ b/smali/com/android/internal/telephony/uicc/UiccController.smali
@@ -306,6 +306,63 @@
 
     invoke-direct {p0, v4}, Lcom/android/internal/telephony/uicc/UiccController;->logWithEnhancedLocalLog(Ljava/lang/String;)V
 
+    const-string v4, "ro.vendor.api_level"
+
+    sget v5, Landroid/os/Build$VERSION;->DEVICE_INITIAL_SDK_INT:I
+
+    invoke-static {v4, v5}, Landroid/os/SystemProperties;->getInt(Ljava/lang/String;I)I
+
+    move-result v4
+
+    new-instance v5, Ljava/lang/StringBuilder;
+
+    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v6, "current vendor api_level: "
+
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v5, v4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-direct {p0, v5}, Lcom/android/internal/telephony/uicc/UiccController;->logWithLocalLog(Ljava/lang/String;)V
+
+    const v5, 0x316a4
+
+    if-gt v4, v5, :cond_0
+
+    new-instance v5, Ljava/lang/StringBuilder;
+
+    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v6, "Adjusting numPhysicalSlots for firstApiLevel = "
+
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v5, v4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string v4, " based on mCis.length"
+
+    invoke-virtual {v5, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v4
+
+    invoke-direct {p0, v4}, Lcom/android/internal/telephony/uicc/UiccController;->logWithLocalLog(Ljava/lang/String;)V
+
+    iget-object v4, p0, Lcom/android/internal/telephony/uicc/UiccController;->mCis:[Lcom/android/internal/telephony/CommandsInterface;
+
+    array-length v5, v4
+
+    if-ge p2, v5, :cond_0
+
+    array-length p2, v4
+
+    :cond_0
     iput p2, p0, Lcom/android/internal/telephony/uicc/UiccController;->PROJECT_SIM_NUM:I
 
     new-instance v4, Ljava/lang/StringBuilder;
@@ -331,7 +388,7 @@
     move v4, v3
 
     :goto_0
-    if-ge v4, p2, :cond_0
+    if-ge v4, p2, :cond_1
 
     iget-object v5, p0, Lcom/android/internal/telephony/uicc/UiccController;->mIccChangedRegistrantsBySlot:[Lcom/android/internal/telephony/RegistrantList;
 
@@ -345,7 +402,7 @@
 
     goto :goto_0
 
-    :cond_0
+    :cond_1
     new-array v4, p2, [I
 
     iput-object v4, p0, Lcom/android/internal/telephony/uicc/UiccController;->mSimTraySwapType:[I
@@ -398,11 +455,11 @@
 
     sget-boolean p2, Lcom/android/internal/telephony/uicc/UiccController;->VDBG:Z
 
-    if-eqz p2, :cond_1
+    if-eqz p2, :cond_2
 
     invoke-direct {p0}, Lcom/android/internal/telephony/uicc/UiccController;->logPhoneIdToSlotIdMapping()V
 
-    :cond_1
+    :cond_2
     invoke-static {}, Lcom/android/internal/telephony/RadioConfig;->getInstance()Lcom/android/internal/telephony/RadioConfig;
 
     move-result-object p2
@@ -422,7 +479,7 @@
 
     array-length v7, v5
 
-    if-ge p2, v7, :cond_2
+    if-ge p2, v7, :cond_3
 
     aget-object v5, v5, p2
 
@@ -516,7 +573,7 @@
 
     goto :goto_1
 
-    :cond_2
+    :cond_3
     new-instance p2, Lcom/android/internal/telephony/uicc/UiccStateChangedLauncher;
 
     iget-object v2, p0, Lcom/android/internal/telephony/uicc/UiccController;->mFeatureFlags:Lcom/android/internal/hidden_from_bootclasspath/com/android/internal/telephony/flags/FeatureFlags;
@@ -547,7 +604,7 @@
 
     move-result p1
 
-    if-eqz p1, :cond_7
+    if-eqz p1, :cond_8
 
     new-instance p1, Ljava/io/File;
 
@@ -559,7 +616,7 @@
 
     move-result p1
 
-    if-eqz p1, :cond_7
+    if-eqz p1, :cond_8
 
     :try_start_0
     new-instance p1, Ljava/io/FileInputStream;
@@ -680,7 +737,7 @@
     :try_end_4
     .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    if-eqz p1, :cond_3
+    if-eqz p1, :cond_4
 
     :try_start_5
     invoke-virtual {p1}, Ljava/io/FileInputStream;->close()V
@@ -692,9 +749,9 @@
 
     goto :goto_5
 
-    :cond_3
+    :cond_4
     :goto_4
-    if-eqz p2, :cond_4
+    if-eqz p2, :cond_5
 
     invoke-virtual {p2}, Ljava/io/BufferedReader;->close()V
     :try_end_5
@@ -717,7 +774,7 @@
 
     invoke-static {v1, p1}, Lcom/android/telephony/Rlog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    :cond_4
+    :cond_5
     :goto_6
     move-object v2, v6
 
@@ -726,7 +783,7 @@
 
     move-result p1
 
-    if-nez p1, :cond_7
+    if-nez p1, :cond_8
 
     new-instance p1, Ljava/lang/StringBuilder;
 
@@ -755,7 +812,7 @@
     goto :goto_c
 
     :goto_8
-    if-eqz v6, :cond_5
+    if-eqz v6, :cond_6
 
     :try_start_6
     invoke-virtual {v6}, Ljava/io/FileInputStream;->close()V
@@ -767,9 +824,9 @@
 
     goto :goto_a
 
-    :cond_5
+    :cond_6
     :goto_9
-    if-eqz p2, :cond_6
+    if-eqz p2, :cond_7
 
     invoke-virtual {p2}, Ljava/io/BufferedReader;->close()V
     :try_end_6
@@ -792,11 +849,11 @@
 
     invoke-static {v1, p1}, Lcom/android/telephony/Rlog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    :cond_6
+    :cond_7
     :goto_b
     throw p0
 
-    :cond_7
+    :cond_8
     :goto_c
     iget-object p1, p0, Lcom/android/internal/telephony/uicc/UiccController;->mContext:Landroid/content/Context;
 
@@ -910,7 +967,7 @@
 
     sget-boolean p1, Lcom/android/internal/telephony/util/TelephonyUtils;->IS_USER:Z
 
-    if-nez p1, :cond_8
+    if-nez p1, :cond_9
 
     iget-object p1, p0, Lcom/android/internal/telephony/uicc/UiccController;->mContext:Landroid/content/Context;
 
@@ -926,7 +983,7 @@
 
     iput-boolean p1, p0, Lcom/android/internal/telephony/uicc/UiccController;->mUseRemovableEsimAsDefault:Z
 
-    :cond_8
+    :cond_9
     return-void
 .end method
 
-- 
2.51.1

