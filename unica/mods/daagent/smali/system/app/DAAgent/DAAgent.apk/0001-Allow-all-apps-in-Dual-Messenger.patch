From 1914932a2439b9ad762bef86b94896f4375e0c40 Mon Sep 17 00:00:00 2001
From: David Arsene <80218600+DavidArsene@users.noreply.github.com>
Date: Fri, 17 Oct 2025 10:45:02 +0200
Subject: [PATCH] Allow all apps in Dual Messenger

---
 AndroidManifest.xml                           |   5 +
 .../da/daagent/provider/DualAppProvider.smali |  60 ++----
 .../da/daagent/provider/WhiteListApps.smali   | 179 +++++++-----------
 .../receiver/DualAppIntentReceiver.smali      |  35 +++-
 .../android/da/daagent/utils/DAUtility.smali  |  50 +----
 5 files changed, 123 insertions(+), 206 deletions(-)

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 445e42a..42547c3 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -59,6 +59,11 @@
                 <action android:name="android.intent.action.LOCALE_CHANGED"/>
                 <action android:name="android.intent.action.MY_PACKAGE_REPLACED"/>
             </intent-filter>
+            <intent-filter android:priority="1000">
+                <action android:name="android.intent.action.PACKAGE_ADDED"/>
+                <action android:name="android.intent.action.PACKAGE_REMOVED"/>
+                <data android:scheme="package"/>
+            </intent-filter>
         </receiver>
         <receiver android:enabled="true" android:exported="true" android:name="com.samsung.android.da.daagent.receiver.DualAppBackupAndRestoreReceiver" android:permission="com.wssnps.permission.COM_WSSNPS">
             <intent-filter android:priority="1000">
diff --git a/smali/com/samsung/android/da/daagent/provider/DualAppProvider.smali b/smali/com/samsung/android/da/daagent/provider/DualAppProvider.smali
index bfaea01..f7d8b6b 100644
--- a/smali/com/samsung/android/da/daagent/provider/DualAppProvider.smali
+++ b/smali/com/samsung/android/da/daagent/provider/DualAppProvider.smali
@@ -512,7 +512,7 @@
 
     const/16 p4, 0x11
 
-    if-ne p2, p3, :cond_f
+    if-ne p2, p3, :cond_d
 
     new-instance p0, Landroid/database/MatrixCursor;
 
@@ -520,42 +520,10 @@
 
     sget-object p1, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
 
-    sget-object p2, Lcom/samsung/android/da/daagent/utils/DAUtility;->mSalesCode:Ljava/lang/String;
-
-    if-eqz p2, :cond_d
-
-    sget-object p3, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->CHINA_SALES_CODES:[Ljava/lang/String;
-
-    array-length p4, p3
-
-    move v0, p5
-
-    :goto_8
-    if-ge v0, p4, :cond_d
-
-    aget-object v1, p3, v0
-
-    invoke-virtual {v1, p2}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v1
-
-    if-eqz v1, :cond_c
-
-    sget-object p1, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES_FOR_CHINA:[Ljava/lang/String;
-
-    goto :goto_9
-
-    :cond_c
-    add-int/lit8 v0, v0, 0x1
-
-    goto :goto_8
-
-    :cond_d
-    :goto_9
     array-length p2, p1
 
-    :goto_a
-    if-ge p5, p2, :cond_e
+    :goto_8
+    if-ge p5, p2, :cond_c
 
     aget-object p3, p1, p5
 
@@ -567,15 +535,15 @@
 
     add-int/lit8 p5, p5, 0x1
 
-    goto :goto_a
+    goto :goto_8
 
-    :cond_e
+    :cond_c
     return-object p0
 
-    :cond_f
+    :cond_d
     const/4 p3, 0x4
 
-    if-ne p2, p3, :cond_10
+    if-ne p2, p3, :cond_e
 
     invoke-virtual {p0}, Landroid/content/ContentProvider;->getContext()Landroid/content/Context;
 
@@ -613,10 +581,10 @@
 
     return-object p0
 
-    :cond_10
+    :cond_e
     const/4 p0, 0x5
 
-    if-ne p2, p0, :cond_12
+    if-ne p2, p0, :cond_10
 
     invoke-static {}, Lcom/samsung/android/da/daagent/fwwrapper/UtilsWrapper;->isChinaModel()Z
 
@@ -626,10 +594,10 @@
 
     sget-object p1, Lcom/samsung/android/da/daagent/DAConstants;->defaultPkgNames:[Ljava/lang/String;
 
-    :goto_b
+    :goto_9
     const/16 p2, 0x1b
 
-    if-ge p5, p2, :cond_11
+    if-ge p5, p2, :cond_f
 
     aget-object p2, p1, p5
 
@@ -641,12 +609,12 @@
 
     add-int/lit8 p5, p5, 0x1
 
-    goto :goto_b
+    goto :goto_9
 
-    :cond_11
+    :cond_f
     return-object p0
 
-    :cond_12
+    :cond_10
     return-object v3
 .end method
 
diff --git a/smali/com/samsung/android/da/daagent/provider/WhiteListApps.smali b/smali/com/samsung/android/da/daagent/provider/WhiteListApps.smali
index 49c1881..81a0f7a 100644
--- a/smali/com/samsung/android/da/daagent/provider/WhiteListApps.smali
+++ b/smali/com/samsung/android/da/daagent/provider/WhiteListApps.smali
@@ -4,178 +4,135 @@
 
 
 # static fields
-.field public static final CHINA_SALES_CODES:[Ljava/lang/String;
+.field public static DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
 
-.field public static final DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
-
-.field public static final DUAL_APP_WHITELIST_PACKAGES_FOR_CHINA:[Ljava/lang/String;
+.field public static sAppsListCount:I
 
 
 # direct methods
-.method static constructor <clinit>()V
-    .locals 20
-
-    const-string v0, "Y29tLmZhY2Vib29rLmthdGFuYQ=="
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v1
-
-    const-string v0, "Y29tLndoYXRzYXBw"
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v2
-
-    const-string v0, "Y29tLmZhY2Vib29rLm9yY2E="
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v3
-
-    const-string v0, "Y29tLnRlbmNlbnQubW9iaWxlcXE="
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v4
-
-    const-string v0, "Y29tLnRlbmNlbnQubW9iaWxlcXFp"
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v5
+.method public static refreshWhiteList(Landroid/content/Context;)V
+    .locals 7
 
-    const-string v0, "Y29tLnRlbmNlbnQubW0="
+    new-instance v0, Ljava/util/ArrayList;
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    invoke-direct {v0}, Ljava/util/ArrayList;-><init>()V
 
-    move-result-object v6
+    new-instance v1, Landroid/content/Intent;
 
-    const-string v0, "Y29tLnNreXBlLnJhaWRlcg=="
+    const-string v2, "android.intent.action.MAIN"
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    const/4 v3, 0x0
 
-    move-result-object v8
+    invoke-direct {v1, v2, v3}, Landroid/content/Intent;-><init>(Ljava/lang/String;Landroid/net/Uri;)V
 
-    const-string v0, "Y29tLnZpYmVyLnZvaXA="
+    const-string v2, "android.intent.category.LAUNCHER"
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    invoke-virtual {v1, v2}, Landroid/content/Intent;->addCategory(Ljava/lang/String;)Landroid/content/Intent;
 
-    move-result-object v9
+    invoke-virtual {p0}, Landroid/content/Context;->getPackageManager()Landroid/content/pm/PackageManager;
 
-    const-string v0, "anAubmF2ZXIubGluZS5hbmRyb2lk"
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v10
-
-    const-string v0, "Y29tLmJibQ=="
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v11
-
-    const-string v0, "b3JnLnRlbGVncmFtLm1lc3Nlbmdlcg=="
-
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    move-result-object p0
 
-    move-result-object v12
+    const/16 v2, 0x80
 
-    const-string v0, "Y29tLmtha2FvLnRhbGs="
+    invoke-virtual {p0, v1, v2}, Landroid/content/pm/PackageManager;->queryIntentActivities(Landroid/content/Intent;I)Ljava/util/List;
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    move-result-object v1
 
-    move-result-object v13
+    invoke-interface {v1}, Ljava/util/List;->size()I
 
-    const-string v0, "Y29tLmJzYi5oaWtl"
+    move-result v2
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    sget v3, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->sAppsListCount:I
 
-    move-result-object v14
+    if-ne v2, v3, :cond_0
 
-    const-string v0, "Y29tLmljcS5tb2JpbGUuY2xpZW50"
+    return-void
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    :cond_0
+    sput v2, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->sAppsListCount:I
 
-    move-result-object v15
+    new-instance v2, Landroid/content/pm/ResolveInfo$DisplayNameComparator;
 
-    const-string v0, "Y29tLnlhaG9vLm1vYmlsZS5jbGllbnQuYW5kcm9pZC5pbQ=="
+    invoke-direct {v2, p0}, Landroid/content/pm/ResolveInfo$DisplayNameComparator;-><init>(Landroid/content/pm/PackageManager;)V
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    invoke-interface {v1, v2}, Ljava/util/List;->sort(Ljava/util/Comparator;)V
 
-    move-result-object v16
+    invoke-interface {v1}, Ljava/util/List;->iterator()Ljava/util/Iterator;
 
-    const-string v0, "Y29tLnppbmcuemFsbw=="
+    move-result-object p0
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    :cond_1
+    :goto_0
+    invoke-interface {p0}, Ljava/util/Iterator;->hasNext()Z
 
-    move-result-object v17
+    move-result v1
 
-    const-string v0, "Y29tLnNuYXBjaGF0LmFuZHJvaWQ="
+    const/4 v2, 0x0
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    if-eqz v1, :cond_4
 
-    move-result-object v18
+    invoke-interface {p0}, Ljava/util/Iterator;->next()Ljava/lang/Object;
 
-    const-string v0, "Y29tLnNpbmEud2VpYm8="
+    move-result-object v1
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    check-cast v1, Landroid/content/pm/ResolveInfo;
 
-    move-result-object v7
+    iget-object v1, v1, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
-    const-string v0, "a2lrLmFuZHJvaWQ="
+    iget-object v1, v1, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    invoke-static {v0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->decodeString(Ljava/lang/String;)Ljava/lang/String;
+    iget v3, v1, Landroid/content/pm/ApplicationInfo;->flags:I
 
-    move-result-object v19
+    and-int/lit16 v3, v3, 0x81
 
-    filled-new-array/range {v1 .. v19}, [Ljava/lang/String;
+    const/4 v4, 0x1
 
-    move-result-object v0
+    if-nez v3, :cond_2
 
-    sput-object v0, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
+    move v3, v4
 
-    filled-new-array {v6, v4, v7}, [Ljava/lang/String;
+    goto :goto_1
 
-    move-result-object v0
+    :cond_2
+    move v3, v2
 
-    sput-object v0, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES_FOR_CHINA:[Ljava/lang/String;
+    :goto_1
+    iget-object v5, v1, Landroid/content/pm/ApplicationInfo;->metaData:Landroid/os/Bundle;
 
-    const-string v3, "CBK"
+    if-eqz v5, :cond_3
 
-    const-string v4, "CTC"
+    const-string v6, "com.samsung.android.multiuser.install_only_owner"
 
-    const-string v1, "CHN"
+    invoke-virtual {v5, v6, v2}, Landroid/os/Bundle;->getBoolean(Ljava/lang/String;Z)Z
 
-    const-string v2, "CHM"
+    move-result v5
 
-    const-string v5, "CHU"
+    if-eqz v5, :cond_3
 
-    const-string v6, "CHC"
+    move v2, v4
 
-    filled-new-array/range {v1 .. v6}, [Ljava/lang/String;
+    :cond_3
+    if-eqz v3, :cond_1
 
-    move-result-object v0
+    if-nez v2, :cond_1
 
-    sput-object v0, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->CHINA_SALES_CODES:[Ljava/lang/String;
+    iget-object v1, v1, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
 
-    return-void
-.end method
+    invoke-interface {v0, v1}, Ljava/util/List;->add(Ljava/lang/Object;)Z
 
-.method public static decodeString(Ljava/lang/String;)Ljava/lang/String;
-    .locals 2
+    goto :goto_0
 
-    const/4 v0, 0x0
+    :cond_4
+    new-array p0, v2, [Ljava/lang/String;
 
-    invoke-static {p0, v0}, Landroid/util/Base64;->decode(Ljava/lang/String;I)[B
+    invoke-interface {v0, p0}, Ljava/util/List;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
 
     move-result-object p0
 
-    new-instance v0, Ljava/lang/String;
+    check-cast p0, [Ljava/lang/String;
 
-    sget-object v1, Ljava/nio/charset/StandardCharsets;->UTF_8:Ljava/nio/charset/Charset;
+    sput-object p0, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
 
-    invoke-direct {v0, p0, v1}, Ljava/lang/String;-><init>([BLjava/nio/charset/Charset;)V
-
-    return-object v0
+    return-void
 .end method
diff --git a/smali/com/samsung/android/da/daagent/receiver/DualAppIntentReceiver.smali b/smali/com/samsung/android/da/daagent/receiver/DualAppIntentReceiver.smali
index 730cc8d..671f176 100644
--- a/smali/com/samsung/android/da/daagent/receiver/DualAppIntentReceiver.smali
+++ b/smali/com/samsung/android/da/daagent/receiver/DualAppIntentReceiver.smali
@@ -33,7 +33,7 @@
 
     const-string v7, "DualAppIntentReceiver"
 
-    if-eqz v3, :cond_24
+    if-eqz v3, :cond_25
 
     invoke-virtual {v3}, Landroid/content/Intent;->getAction()Ljava/lang/String;
 
@@ -325,6 +325,8 @@
 
     if-eqz v0, :cond_16
 
+    invoke-static {v2}, Lcom/samsung/android/da/daagent/utils/DAUtility;->updateWhitelistAppsInSystemServer(Landroid/content/Context;)V
+
     invoke-static {v2}, Lcom/samsung/android/da/daagent/service/SendSaLogService;->schedule(Landroid/content/Context;)V
 
     invoke-static {}, Lcom/samsung/android/da/daagent/utils/DAUtility;->getDualAppProfileId()I
@@ -694,8 +696,6 @@
     goto :goto_e
 
     :cond_12
-    invoke-static {v2}, Lcom/samsung/android/da/daagent/utils/DAUtility;->updateWhitelistAppsInSystemServer(Landroid/content/Context;)V
-
     new-instance v1, Landroid/os/Bundle;
 
     invoke-direct {v1}, Landroid/os/Bundle;-><init>()V
@@ -847,7 +847,7 @@
 
     move-result-object v0
 
-    if-eqz v0, :cond_23
+    if-eqz v0, :cond_24
 
     const-string v1, "result_code"
 
@@ -926,14 +926,14 @@
 
     move-result-object v1
 
-    if-eqz v1, :cond_23
+    if-eqz v1, :cond_24
 
     move v5, v8
 
     :goto_12
     array-length v7, v1
 
-    if-ge v5, v7, :cond_23
+    if-ge v5, v7, :cond_24
 
     aget-object v7, v1, v5
 
@@ -1254,15 +1254,32 @@
 
     move-result v0
 
-    if-eqz v0, :cond_23
+    if-nez v0, :cond_23
 
-    invoke-static {v2}, Lcom/samsung/android/da/daagent/utils/DAUtility;->updateWhitelistAppsInSystemServer(Landroid/content/Context;)V
+    const-string v0, "android.intent.action.PACKAGE_ADDED"
+
+    invoke-virtual {v0, v1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_23
+
+    const-string v0, "android.intent.action.PACKAGE_REMOVED"
+
+    invoke-virtual {v0, v1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_24
 
     :cond_23
+    invoke-static {v2}, Lcom/samsung/android/da/daagent/utils/DAUtility;->updateWhitelistAppsInSystemServer(Landroid/content/Context;)V
+
+    :cond_24
     :goto_18
     return-void
 
-    :cond_24
+    :cond_25
     :goto_19
     const-string v0, "DualAppIntentReceiver onReceive() intent is null"
 
diff --git a/smali/com/samsung/android/da/daagent/utils/DAUtility.smali b/smali/com/samsung/android/da/daagent/utils/DAUtility.smali
index 67af4f2..4a9de41 100644
--- a/smali/com/samsung/android/da/daagent/utils/DAUtility.smali
+++ b/smali/com/samsung/android/da/daagent/utils/DAUtility.smali
@@ -1947,50 +1947,20 @@
 
     invoke-direct {v1}, Ljava/util/HashMap;-><init>()V
 
-    sget-object v2, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
+    invoke-static {p0}, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->refreshWhiteList(Landroid/content/Context;)V
 
-    sget-object v3, Lcom/samsung/android/da/daagent/utils/DAUtility;->mSalesCode:Ljava/lang/String;
+    sget-object v2, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES:[Ljava/lang/String;
 
     const/4 v4, 0x0
 
-    if-eqz v3, :cond_1
-
-    sget-object v5, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->CHINA_SALES_CODES:[Ljava/lang/String;
-
-    array-length v6, v5
-
-    move v7, v4
-
-    :goto_0
-    if-ge v7, v6, :cond_1
-
-    aget-object v8, v5, v7
-
-    invoke-virtual {v8, v3}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v8
-
-    if-eqz v8, :cond_0
-
-    sget-object v2, Lcom/samsung/android/da/daagent/provider/WhiteListApps;->DUAL_APP_WHITELIST_PACKAGES_FOR_CHINA:[Ljava/lang/String;
-
-    goto :goto_1
-
-    :cond_0
-    add-int/lit8 v7, v7, 0x1
-
-    goto :goto_0
-
-    :cond_1
-    :goto_1
     array-length v3, v2
 
     move v5, v4
 
-    :goto_2
+    :goto_0
     const-string v6, "DA_DAUtility"
 
-    if-ge v5, v3, :cond_2
+    if-ge v5, v3, :cond_0
 
     aget-object v7, v2, v5
 
@@ -2003,7 +1973,7 @@
     :try_end_0
     .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
 
-    goto :goto_3
+    goto :goto_1
 
     :catch_0
     move-exception v7
@@ -2018,12 +1988,12 @@
 
     invoke-virtual {v7}, Ljava/lang/Exception;->printStackTrace()V
 
-    :goto_3
+    :goto_1
     add-int/lit8 v5, v5, 0x1
 
-    goto :goto_2
+    goto :goto_0
 
-    :cond_2
+    :cond_0
     const-string v2, "command"
 
     const-string v3, "updateWhitelistPkgs"
@@ -2060,7 +2030,7 @@
 
     move-result-object p0
 
-    if-eqz p0, :cond_3
+    if-eqz p0, :cond_1
 
     const-string v0, "result_code"
 
@@ -2094,6 +2064,6 @@
 
     invoke-static {v6, p0}, Lcom/samsung/android/da/daagent/fwwrapper/LogWrapper;->d(Ljava/lang/String;Ljava/lang/String;)V
 
-    :cond_3
+    :cond_1
     return-void
 .end method
-- 
2.51.2

