From 07df021f2666afcaffd9e882560626581ac6d7f5 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Fri, 24 Oct 2025 14:21:42 +0200
Subject: [PATCH] Allow disabling secure windows

---
 ...indowManagerService$SettingsObserver.smali | 47 +++++++------------
 1 file changed, 16 insertions(+), 31 deletions(-)

diff --git a/smali_classes2/com/android/server/wm/WindowManagerService$SettingsObserver.smali b/smali_classes2/com/android/server/wm/WindowManagerService$SettingsObserver.smali
index 5a7ae767c..e894586fe 100644
--- a/smali_classes2/com/android/server/wm/WindowManagerService$SettingsObserver.smali
+++ b/smali_classes2/com/android/server/wm/WindowManagerService$SettingsObserver.smali
@@ -93,9 +93,9 @@
 
     move-result-object v6
 
-    const-string/jumbo v7, "disable_secure_windows"
+    const-string/jumbo v7, "unica_secure_ss"
 
-    invoke-static {v7}, Landroid/provider/Settings$Secure;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
+    invoke-static {v7}, Landroid/provider/Settings$System;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
 
     move-result-object v7
 
@@ -847,20 +847,6 @@
 .method public final updateDisableSecureWindows()V
     .locals 3
 
-    const-string/jumbo v0, "ro.debuggable"
-
-    const/4 v1, 0x0
-
-    invoke-static {v0, v1}, Landroid/os/SystemProperties;->getBoolean(Ljava/lang/String;Z)Z
-
-    move-result v0
-
-    if-nez v0, :cond_0
-
-    goto :goto_0
-
-    :cond_0
-    :try_start_0
     iget-object v0, p0, Lcom/android/server/wm/WindowManagerService$SettingsObserver;->this$0:Lcom/android/server/wm/WindowManagerService;
 
     iget-object v0, v0, Lcom/android/server/wm/WindowManagerService;->mContext:Landroid/content/Context;
@@ -869,29 +855,28 @@
 
     move-result-object v0
 
-    const-string/jumbo v2, "disable_secure_windows"
+    const/4 v1, 0x0
 
-    invoke-static {v0, v2, v1}, Landroid/provider/Settings$Secure;->getIntForUser(Landroid/content/ContentResolver;Ljava/lang/String;I)I
+    const-string/jumbo v2, "unica_secure_ss"
+
+    invoke-static {v0, v2, v1}, Landroid/provider/Settings$System;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I
 
     move-result v0
-    :try_end_0
-    .catch Landroid/provider/Settings$SettingNotFoundException; {:try_start_0 .. :try_end_0} :catch_0
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_0
 
     const/4 v1, 0x1
 
-    :catch_0
-    :cond_1
+    :cond_0
     iget-object v0, p0, Lcom/android/server/wm/WindowManagerService$SettingsObserver;->this$0:Lcom/android/server/wm/WindowManagerService;
 
     iget-boolean v0, v0, Lcom/android/server/wm/WindowManagerService;->mDisableSecureWindows:Z
 
-    if-ne v0, v1, :cond_2
+    if-ne v0, v1, :cond_1
 
     goto :goto_0
 
-    :cond_2
+    :cond_1
     iget-object v0, p0, Lcom/android/server/wm/WindowManagerService$SettingsObserver;->this$0:Lcom/android/server/wm/WindowManagerService;
 
     iget-object v0, v0, Lcom/android/server/wm/WindowManagerService;->mGlobalLock:Lcom/android/server/wm/WindowManagerGlobalLock;
@@ -900,7 +885,7 @@
 
     monitor-enter v0
 
-    :try_start_1
+    :try_start_0
     iget-object v2, p0, Lcom/android/server/wm/WindowManagerService$SettingsObserver;->this$0:Lcom/android/server/wm/WindowManagerService;
 
     iput-boolean v1, v2, Lcom/android/server/wm/WindowManagerService;->mDisableSecureWindows:Z
@@ -912,8 +897,8 @@
     invoke-virtual {p0}, Lcom/android/server/wm/RootWindowContainer;->refreshSecureSurfaceState()V
 
     monitor-exit v0
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     invoke-static {}, Lcom/android/server/wm/WindowManagerService;->resetPriorityAfterLockedSection()V
 
@@ -923,10 +908,10 @@
     :catchall_0
     move-exception p0
 
-    :try_start_2
+    :try_start_1
     monitor-exit v0
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     invoke-static {}, Lcom/android/server/wm/WindowManagerService;->resetPriorityAfterLockedSection()V
 
-- 
2.51.1

