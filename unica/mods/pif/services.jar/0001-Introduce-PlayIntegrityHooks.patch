From 7cf693c9e91909663c730e89273661e9d34187bd Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Thu, 2 Oct 2025 20:48:54 +0200
Subject: [PATCH] Introduce PlayIntegrityHooks

---
 .../wm/ActivityTaskManagerService.smali       | 42 +++++++++++++------
 1 file changed, 30 insertions(+), 12 deletions(-)

diff --git a/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali b/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
index a6a0faebd..2052d1a4c 100644
--- a/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
+++ b/smali_classes2/com/android/server/wm/ActivityTaskManagerService.smali
@@ -6766,10 +6766,19 @@
 .method public final getFocusedRootTaskInfo()Landroid/app/ActivityTaskManager$RootTaskInfo;
     .locals 5
 
+    iget-object v0, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v0}, Lio/mesalabs/unica/PlayIntegrityHooks;->shouldBypassTaskPermission(Landroid/content/Context;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
     const-string/jumbo v0, "getFocusedRootTaskInfo()"
 
     invoke-static {v0}, Lcom/android/server/wm/ActivityTaskManagerService;->enforceTaskPermission(Ljava/lang/String;)V
 
+    :cond_0
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
     move-result-wide v0
@@ -6792,7 +6801,7 @@
 
     const/4 v4, 0x0
 
-    if-eqz v3, :cond_1
+    if-eqz v3, :cond_2
 
     iget-object p0, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mRootWindowContainer:Lcom/android/server/wm/RootWindowContainer;
 
@@ -6802,13 +6811,13 @@
 
     move-result-object p0
 
-    if-eqz p0, :cond_0
+    if-eqz p0, :cond_1
 
     invoke-static {p0}, Lcom/android/server/wm/RootWindowContainer;->getRootTaskInfo(Lcom/android/server/wm/Task;)Landroid/app/ActivityTaskManager$RootTaskInfo;
 
     move-result-object v4
 
-    :cond_0
+    :cond_1
     monitor-exit v2
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_0
@@ -6825,7 +6834,7 @@
 
     goto :goto_1
 
-    :cond_1
+    :cond_2
     :try_start_2
     monitor-exit v2
 
@@ -12876,17 +12885,26 @@
 .method public final registerTaskStackListener(Landroid/app/ITaskStackListener;)V
     .locals 2
 
+    iget-object v0, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v0}, Lio/mesalabs/unica/PlayIntegrityHooks;->shouldBypassTaskPermission(Landroid/content/Context;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
     const-string/jumbo v0, "registerTaskStackListener()"
 
     invoke-static {v0}, Lcom/android/server/wm/ActivityTaskManagerService;->enforceTaskPermission(Ljava/lang/String;)V
 
+    :cond_0
     iget-object p0, p0, Lcom/android/server/wm/ActivityTaskManagerService;->mTaskChangeNotificationController:Lcom/android/server/wm/TaskChangeNotificationController;
 
     invoke-virtual {p0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
 
     instance-of v0, p1, Landroid/os/Binder;
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     iget-object v0, p0, Lcom/android/server/wm/TaskChangeNotificationController;->mLocalTaskStackListeners:Ljava/util/ArrayList;
 
@@ -12899,11 +12917,11 @@
 
     move-result v1
 
-    if-nez v1, :cond_1
+    if-nez v1, :cond_2
 
     instance-of v1, p1, Landroid/app/TaskStackListener;
 
-    if-eqz v1, :cond_0
+    if-eqz v1, :cond_1
 
     move-object v1, p1
 
@@ -12918,13 +12936,13 @@
 
     goto :goto_1
 
-    :cond_0
+    :cond_1
     :goto_0
     iget-object p0, p0, Lcom/android/server/wm/TaskChangeNotificationController;->mLocalTaskStackListeners:Ljava/util/ArrayList;
 
     invoke-virtual {p0, p1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    :cond_1
+    :cond_2
     monitor-exit v0
 
     return-void
@@ -12936,14 +12954,14 @@
 
     throw p0
 
-    :cond_2
-    if-eqz p1, :cond_3
+    :cond_3
+    if-eqz p1, :cond_4
 
     iget-object p0, p0, Lcom/android/server/wm/TaskChangeNotificationController;->mRemoteTaskStackListeners:Landroid/os/RemoteCallbackList;
 
     invoke-virtual {p0, p1}, Landroid/os/RemoteCallbackList;->register(Landroid/os/IInterface;)Z
 
-    :cond_3
+    :cond_4
     return-void
 .end method
 
-- 
2.51.0

