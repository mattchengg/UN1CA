From a94954e481adbed6272d4ab000a2bb4c848cef4c Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Thu, 30 Oct 2025 20:28:06 +0100
Subject: [PATCH] Add token argument in unlockCeStorage

---
 smali/android/os/IVold$Default.smali                 | 2 +-
 smali/android/os/IVold$Stub$Proxy.smali              | 6 ++++--
 smali/android/os/IVold$Stub.smali                    | 8 ++++++--
 smali/android/os/IVold.smali                         | 2 +-
 smali/com/android/server/StorageManagerService.smali | 6 ++++--
 5 files changed, 16 insertions(+), 8 deletions(-)

diff --git a/smali/android/os/IVold$Default.smali b/smali/android/os/IVold$Default.smali
index f309c5f46..8037e7de4 100644
--- a/smali/android/os/IVold$Default.smali
+++ b/smali/android/os/IVold$Default.smali
@@ -1356,7 +1356,7 @@
     return p0
 .end method
 
-.method public unlockCeStorage(I[B)V
+.method public unlockCeStorage(ILjava/lang/String;[B)V
     .locals 0
     .annotation system Ldalvik/annotation/Throws;
         value = {
diff --git a/smali/android/os/IVold$Stub$Proxy.smali b/smali/android/os/IVold$Stub$Proxy.smali
index 723a90129..a9266b171 100644
--- a/smali/android/os/IVold$Stub$Proxy.smali
+++ b/smali/android/os/IVold$Stub$Proxy.smali
@@ -6017,7 +6017,7 @@
     throw p0
 .end method
 
-.method public final unlockCeStorage(I[B)V
+.method public final unlockCeStorage(ILjava/lang/String;[B)V
     .locals 3
 
     iget-object v0, p0, Landroid/os/IVold$Stub$Proxy;->mRemote:Landroid/os/IBinder;
@@ -6039,7 +6039,9 @@
 
     invoke-virtual {v0, p1}, Landroid/os/Parcel;->writeInt(I)V
 
-    invoke-virtual {v0, p2}, Landroid/os/Parcel;->writeByteArray([B)V
+    invoke-virtual {v0, p2}, Landroid/os/Parcel;->writeString(Ljava/lang/String;)V
+
+    invoke-virtual {v0, p3}, Landroid/os/Parcel;->writeByteArray([B)V
 
     iget-object p0, p0, Landroid/os/IVold$Stub$Proxy;->mRemote:Landroid/os/IBinder;
 
diff --git a/smali/android/os/IVold$Stub.smali b/smali/android/os/IVold$Stub.smali
index b3694388f..ba29d8e78 100644
--- a/smali/android/os/IVold$Stub.smali
+++ b/smali/android/os/IVold$Stub.smali
@@ -1400,13 +1400,17 @@
 
     move-result v1
 
-    invoke-virtual {p2}, Landroid/os/Parcel;->createByteArray()[B
+    invoke-virtual {p2}, Landroid/os/Parcel;->readString()Ljava/lang/String;
 
     move-result-object v2
 
+    invoke-virtual {p2}, Landroid/os/Parcel;->createByteArray()[B
+
+    move-result-object v3
+
     invoke-virtual {p2}, Landroid/os/Parcel;->enforceNoDataAvail()V
 
-    invoke-interface {p0, v1, v2}, Landroid/os/IVold;->unlockCeStorage(I[B)V
+    invoke-interface {p0, v1, v2, v3}, Landroid/os/IVold;->unlockCeStorage(ILjava/lang/String;[B)V
 
     invoke-virtual {p3}, Landroid/os/Parcel;->writeNoException()V
 
diff --git a/smali/android/os/IVold.smali b/smali/android/os/IVold.smali
index ff953826b..49838439a 100644
--- a/smali/android/os/IVold.smali
+++ b/smali/android/os/IVold.smali
@@ -979,7 +979,7 @@
     .end annotation
 .end method
 
-.method public abstract unlockCeStorage(I[B)V
+.method public abstract unlockCeStorage(ILjava/lang/String;[B)V
     .annotation system Ldalvik/annotation/Throws;
         value = {
             Landroid/os/RemoteException;
diff --git a/smali/com/android/server/StorageManagerService.smali b/smali/com/android/server/StorageManagerService.smali
index e5e12046a..352f3b87d 100644
--- a/smali/com/android/server/StorageManagerService.smali
+++ b/smali/com/android/server/StorageManagerService.smali
@@ -15940,7 +15940,7 @@
 .end method
 
 .method public final unlockCeStorage(I[B)V
-    .locals 1
+    .locals 2
 
     invoke-virtual {p0}, Landroid/os/storage/IStorageManager$Stub;->unlockCeStorage_enforcePermission()V
 
@@ -15952,7 +15952,9 @@
 
     iget-object v0, p0, Lcom/android/server/StorageManagerService;->mVold:Landroid/os/IVold;
 
-    invoke-interface {v0, p1, p2}, Landroid/os/IVold;->unlockCeStorage(I[B)V
+    const-string v1, "!"
+
+    invoke-interface {v0, p1, v1, p2}, Landroid/os/IVold;->unlockCeStorage(ILjava/lang/String;[B)V
 
     :cond_0
     iget-object p2, p0, Lcom/android/server/StorageManagerService;->mLock:Ljava/lang/Object;
-- 
2.51.1

