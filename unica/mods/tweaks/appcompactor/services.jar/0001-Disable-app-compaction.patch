From c19b626ad03312542e186f04b5ca7f1f88701ee3 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Fri, 31 Oct 2025 09:50:37 +0100
Subject: [PATCH] Disable app compaction

---
 .../server/am/CachedAppOptimizer.smali        | 118 ++++++++----------
 .../android/server/am/DynamicHiddenApp.smali  |  18 +--
 2 files changed, 55 insertions(+), 81 deletions(-)

diff --git a/smali/com/android/server/am/CachedAppOptimizer.smali b/smali/com/android/server/am/CachedAppOptimizer.smali
index 47946bd94..742842d1f 100644
--- a/smali/com/android/server/am/CachedAppOptimizer.smali
+++ b/smali/com/android/server/am/CachedAppOptimizer.smali
@@ -48,7 +48,7 @@
 
 .field static final DEFAULT_STATSD_SAMPLE_RATE:F = 0.1f
 
-.field static final DEFAULT_USE_COMPACTION:Z = true
+.field static final DEFAULT_USE_COMPACTION:Z = false
 
 .field static final DEFAULT_USE_FREEZER:Z = true
 
@@ -104,8 +104,6 @@
 
 
 # instance fields
-.field public final isDebuggable:Z
-
 .field public final mAm:Lcom/android/server/am/ActivityManagerService;
 
 .field public final mCachedAppOptimizerReclaimer:Lcom/android/server/am/CachedAppOptimizer$CachedAppOptimizerReclaimer;
@@ -395,65 +393,51 @@
 .method public constructor <init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/CachedAppOptimizer$PropertyChangedCallbackForTest;Lcom/android/server/am/CachedAppOptimizer$ProcessDependencies;)V
     .locals 7
 
-    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
-
-    const-string/jumbo v0, "ro.debuggable"
-
-    const/4 v1, 0x0
-
-    invoke-static {v0, v1}, Landroid/os/SemSystemProperties;->getInt(Ljava/lang/String;I)I
-
-    move-result v0
-
-    const/4 v2, 0x1
-
-    if-ne v0, v2, :cond_0
+    const/4 v0, 0x1
 
-    move v0, v2
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    goto :goto_0
+    const-string/jumbo v1, "ro.debuggable"
 
-    :cond_0
-    move v0, v1
+    const/4 v2, 0x0
 
-    :goto_0
-    iput-boolean v0, p0, Lcom/android/server/am/CachedAppOptimizer;->isDebuggable:Z
+    invoke-static {v1, v2}, Landroid/os/SemSystemProperties;->getInt(Ljava/lang/String;I)I
 
-    new-instance v0, Ljava/util/ArrayList;
+    new-instance v1, Ljava/util/ArrayList;
 
-    invoke-direct {v0}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct {v1}, Ljava/util/ArrayList;-><init>()V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mPendingCompactionProcesses:Ljava/util/ArrayList;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mPendingCompactionProcesses:Ljava/util/ArrayList;
 
-    new-instance v0, Landroid/util/SparseArray;
+    new-instance v1, Landroid/util/SparseArray;
 
-    invoke-direct {v0}, Landroid/util/SparseArray;-><init>()V
+    invoke-direct {v1}, Landroid/util/SparseArray;-><init>()V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFrozenProcesses:Landroid/util/SparseArray;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFrozenProcesses:Landroid/util/SparseArray;
 
-    new-instance v0, Ljava/lang/Object;
+    new-instance v1, Ljava/lang/Object;
 
-    invoke-direct {v0}, Ljava/lang/Object;-><init>()V
+    invoke-direct {v1}, Ljava/lang/Object;-><init>()V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerLock:Ljava/lang/Object;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerLock:Ljava/lang/Object;
 
-    new-instance v0, Lcom/android/server/am/CachedAppOptimizer$1;
+    new-instance v1, Lcom/android/server/am/CachedAppOptimizer$1;
 
-    invoke-direct {v0, p0, v1}, Lcom/android/server/am/CachedAppOptimizer$1;-><init>(Lcom/android/server/am/CachedAppOptimizer;I)V
+    invoke-direct {v1, p0, v2}, Lcom/android/server/am/CachedAppOptimizer$1;-><init>(Lcom/android/server/am/CachedAppOptimizer;I)V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mOnFlagsChangedListener:Lcom/android/server/am/CachedAppOptimizer$1;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mOnFlagsChangedListener:Lcom/android/server/am/CachedAppOptimizer$1;
 
-    new-instance v0, Lcom/android/server/am/CachedAppOptimizer$1;
+    new-instance v1, Lcom/android/server/am/CachedAppOptimizer$1;
 
-    invoke-direct {v0, p0, v2}, Lcom/android/server/am/CachedAppOptimizer$1;-><init>(Lcom/android/server/am/CachedAppOptimizer;I)V
+    invoke-direct {v1, p0, v0}, Lcom/android/server/am/CachedAppOptimizer$1;-><init>(Lcom/android/server/am/CachedAppOptimizer;I)V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mOnNativeBootFlagsChangedListener:Lcom/android/server/am/CachedAppOptimizer$1;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mOnNativeBootFlagsChangedListener:Lcom/android/server/am/CachedAppOptimizer$1;
 
-    new-instance v0, Ljava/lang/Object;
+    new-instance v1, Ljava/lang/Object;
 
-    invoke-direct {v0}, Ljava/lang/Object;-><init>()V
+    invoke-direct {v1}, Ljava/lang/Object;-><init>()V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mPhenotypeFlagLock:Ljava/lang/Object;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mPhenotypeFlagLock:Ljava/lang/Object;
 
     const-wide/16 v3, 0x1388
 
@@ -479,21 +463,21 @@
 
     iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mUseCompaction:Z
 
-    iput-boolean v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mUseFreezer:Z
+    iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mUseFreezer:Z
 
-    iput v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerDisableCount:I
+    iput v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerDisableCount:I
 
-    new-instance v0, Ljava/util/Random;
+    new-instance v1, Ljava/util/Random;
 
-    invoke-direct {v0}, Ljava/util/Random;-><init>()V
+    invoke-direct {v1}, Ljava/util/Random;-><init>()V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mRandom:Ljava/util/Random;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mRandom:Ljava/util/Random;
 
-    const v0, 0x3dcccccd    # 0.1f
+    const v1, 0x3dcccccd    # 0.1f
 
-    iput v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mCompactStatsdSampleRate:F
+    iput v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mCompactStatsdSampleRate:F
 
-    iput v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerStatsdSampleRate:F
+    iput v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerStatsdSampleRate:F
 
     const-wide/16 v5, 0x2ee0
 
@@ -503,33 +487,33 @@
 
     iput-wide v5, p0, Lcom/android/server/am/CachedAppOptimizer;->mFullDeltaRssThrottleKb:J
 
-    iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderEnabled:Z
+    iput-boolean v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderEnabled:Z
 
     const-wide/16 v5, 0x4
 
     iput-wide v5, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderDivisor:J
 
-    const/16 v0, 0x1f4
+    const/16 v1, 0x1f4
 
-    iput v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderOffset:I
+    iput v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderOffset:I
 
     const-wide/16 v5, 0x3e8
 
     iput-wide v5, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderThreshold:J
 
-    iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderCallbackEnabled:Z
+    iput-boolean v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderCallbackEnabled:Z
 
     iput-wide v3, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderCallbackThrottle:J
 
-    const/16 v0, 0x400
+    const/16 v1, 0x400
 
-    iput v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderAsyncThreshold:I
+    iput v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerBinderAsyncThreshold:I
 
-    const/4 v0, 0x0
+    const/4 v1, 0x0
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mCompactStatsManager:Lcom/android/server/am/compaction/CompactionStatsManager;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mCompactStatsManager:Lcom/android/server/am/compaction/CompactionStatsManager;
 
-    iput-boolean v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerOverride:Z
+    iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerOverride:Z
 
     const-wide/16 v5, -0x1
 
@@ -537,27 +521,27 @@
 
     iput-wide v3, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerDebounceTimeout:J
 
-    iput-boolean v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerExemptInstPkg:Z
+    iput-boolean v2, p0, Lcom/android/server/am/CachedAppOptimizer;->mFreezerExemptInstPkg:Z
 
-    new-instance v0, Ljava/util/ArrayList;
+    new-instance v1, Ljava/util/ArrayList;
 
-    invoke-direct {v0}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct {v1}, Ljava/util/ArrayList;-><init>()V
 
     iput-object p1, p0, Lcom/android/server/am/CachedAppOptimizer;->mAm:Lcom/android/server/am/ActivityManagerService;
 
-    iget-object v0, p1, Lcom/android/server/am/ActivityManagerService;->mProcLock:Lcom/android/server/am/ActivityManagerProcLock;
+    iget-object v1, p1, Lcom/android/server/am/ActivityManagerService;->mProcLock:Lcom/android/server/am/ActivityManagerProcLock;
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mProcLock:Lcom/android/server/am/ActivityManagerProcLock;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mProcLock:Lcom/android/server/am/ActivityManagerProcLock;
 
-    new-instance v0, Lcom/android/server/ServiceThread;
+    new-instance v1, Lcom/android/server/ServiceThread;
 
-    const-string v1, "CachedAppOptimizerThread"
+    const-string v2, "CachedAppOptimizerThread"
 
     const/4 v3, 0x2
 
-    invoke-direct {v0, v1, v3, v2}, Lcom/android/server/ServiceThread;-><init>(Ljava/lang/String;IZ)V
+    invoke-direct {v1, v2, v3, v0}, Lcom/android/server/ServiceThread;-><init>(Ljava/lang/String;IZ)V
 
-    iput-object v0, p0, Lcom/android/server/am/CachedAppOptimizer;->mCachedAppOptimizerThread:Lcom/android/server/ServiceThread;
+    iput-object v1, p0, Lcom/android/server/am/CachedAppOptimizer;->mCachedAppOptimizerThread:Lcom/android/server/ServiceThread;
 
     new-instance v0, Ljava/util/HashSet;
 
@@ -2793,7 +2777,7 @@
 .method public final updateUseCompaction()V
     .locals 3
 
-    const/4 v0, 0x1
+    const/4 v0, 0x0
 
     const-string/jumbo v1, "activity_manager"
 
diff --git a/smali/com/android/server/am/DynamicHiddenApp.smali b/smali/com/android/server/am/DynamicHiddenApp.smali
index 12bf257cc..5a37a3161 100644
--- a/smali/com/android/server/am/DynamicHiddenApp.smali
+++ b/smali/com/android/server/am/DynamicHiddenApp.smali
@@ -1006,27 +1006,17 @@
 
     invoke-static {v0, v1, p1}, Lcom/android/server/BinaryTransparencyService$$ExternalSyntheticOutline0;->m(Ljava/lang/StringBuilder;ZLjava/io/PrintWriter;)V
 
-    iget-object v0, p0, Lcom/android/server/am/DynamicHiddenApp;->mAm:Lcom/android/server/am/ActivityManagerService;
-
-    if-eqz v0, :cond_1
-
-    new-instance v0, Ljava/lang/StringBuilder;
-
-    const-string v1, "  APPCOMPACTOR_ENABLE "
-
-    invoke-direct {v0, v1}, Ljava/lang/StringBuilder;-><init>(Ljava/lang/String;)V
-
     iget-object p0, p0, Lcom/android/server/am/DynamicHiddenApp;->mAm:Lcom/android/server/am/ActivityManagerService;
 
+    if-eqz p0, :cond_1
+
     iget-object p0, p0, Lcom/android/server/am/ActivityManagerService;->mOomAdjuster:Lcom/android/server/am/OomAdjuster;
 
     iget-object p0, p0, Lcom/android/server/am/OomAdjuster;->mCachedAppOptimizer:Lcom/android/server/am/CachedAppOptimizer;
 
-    iget-boolean p0, p0, Lcom/android/server/am/CachedAppOptimizer;->isDebuggable:Z
-
-    xor-int/lit8 p0, p0, 0x1
+    const-string p0, "  APPCOMPACTOR_ENABLE false"
 
-    invoke-static {v0, p0, p1}, Lcom/android/server/BinaryTransparencyService$$ExternalSyntheticOutline0;->m(Ljava/lang/StringBuilder;ZLjava/io/PrintWriter;)V
+    invoke-virtual {p1, p0}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
     :cond_1
     invoke-virtual {p1}, Ljava/io/PrintWriter;->println()V
-- 
2.51.1

