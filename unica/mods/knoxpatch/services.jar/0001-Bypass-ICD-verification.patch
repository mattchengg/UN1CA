From f09896471663b13c5649d607f113bb844e9574ca Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Fri, 3 Oct 2025 16:22:12 +0200
Subject: [PATCH] Bypass ICD verification

---
 .../DevicePolicyManagerService.smali          | 18 +--------------
 .../server/knox/dar/DarManagerService.smali   |  2 +-
 .../server/pm/UserManagerService.smali        | 20 +---------------
 .../AttestParameterSpec$Builder.smali         |  6 -----
 .../keystore/AttestParameterSpec.smali        | 10 +++-----
 .../security/keystore/AttestationUtils.smali  | 23 ++++++++-----------
 .../ssdid/SemSsdidManagerService.smali        |  2 +-
 7 files changed, 16 insertions(+), 65 deletions(-)

diff --git a/smali/com/android/server/devicepolicy/DevicePolicyManagerService.smali b/smali/com/android/server/devicepolicy/DevicePolicyManagerService.smali
index 356749b10..a0ea81cd5 100644
--- a/smali/com/android/server/devicepolicy/DevicePolicyManagerService.smali
+++ b/smali/com/android/server/devicepolicy/DevicePolicyManagerService.smali
@@ -63099,29 +63099,13 @@
 
     invoke-direct {v13, v0, v14}, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;-><init>(Ljava/lang/String;[B)V
 
-    const-class v14, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;
-
-    const-string/jumbo v15, "mVerifiableIntegrity"
-
-    invoke-virtual {v14, v15}, Ljava/lang/Class;->getDeclaredField(Ljava/lang/String;)Ljava/lang/reflect/Field;
-
-    move-result-object v14
-
-    invoke-virtual {v14, v9}, Ljava/lang/reflect/Field;->setAccessible(Z)V
-
-    sget-object v15, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
-
-    invoke-virtual {v14, v13, v15}, Ljava/lang/reflect/Field;->set(Ljava/lang/Object;Ljava/lang/Object;)V
-
     new-instance v14, Lcom/samsung/android/security/keystore/AttestParameterSpec;
 
-    iget-boolean v15, v13, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mVerifiableIntegrity:Z
-
     iget-object v9, v13, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mSpec:Landroid/security/keystore/KeyGenParameterSpec;
 
     iget-object v13, v13, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mChallenge:[B
 
-    invoke-direct {v14, v13, v15, v8, v9}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+    invoke-direct {v14, v13, v8, v9}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
 
     invoke-virtual {v12, v14}, Lcom/samsung/android/security/keystore/AttestationUtils;->generateKeyPair(Lcom/samsung/android/security/keystore/AttestParameterSpec;)Ljava/security/KeyPair;
 
diff --git a/smali/com/android/server/knox/dar/DarManagerService.smali b/smali/com/android/server/knox/dar/DarManagerService.smali
index 678503bf9..a9e973951 100644
--- a/smali/com/android/server/knox/dar/DarManagerService.smali
+++ b/smali/com/android/server/knox/dar/DarManagerService.smali
@@ -3983,7 +3983,7 @@
 
     new-instance v8, Lcom/samsung/android/security/keystore/AttestParameterSpec;
 
-    invoke-direct {v8, v6, v2, v1, v7}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+    invoke-direct {v8, v6, v1, v7}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
 
     invoke-virtual {v5, v8}, Lcom/samsung/android/security/keystore/AttestationUtils;->generateKeyPair(Lcom/samsung/android/security/keystore/AttestParameterSpec;)Ljava/security/KeyPair;
 
diff --git a/smali_classes2/com/android/server/pm/UserManagerService.smali b/smali_classes2/com/android/server/pm/UserManagerService.smali
index 453116d24..1b8793cd5 100644
--- a/smali_classes2/com/android/server/pm/UserManagerService.smali
+++ b/smali_classes2/com/android/server/pm/UserManagerService.smali
@@ -6627,26 +6627,8 @@
 
     invoke-direct {v6, v0, v7}, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;-><init>(Ljava/lang/String;[B)V
 
-    const-class v7, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;
-
-    const-string/jumbo v11, "mVerifiableIntegrity"
-
-    invoke-virtual {v7, v11}, Ljava/lang/Class;->getDeclaredField(Ljava/lang/String;)Ljava/lang/reflect/Field;
-
-    move-result-object v7
-
-    const/4 v11, 0x1
-
-    invoke-virtual {v7, v11}, Ljava/lang/reflect/Field;->setAccessible(Z)V
-
-    sget-object v11, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
-
-    invoke-virtual {v7, v6, v11}, Ljava/lang/reflect/Field;->set(Ljava/lang/Object;Ljava/lang/Object;)V
-
     new-instance v7, Lcom/samsung/android/security/keystore/AttestParameterSpec;
 
-    iget-boolean v11, v6, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mVerifiableIntegrity:Z
-
     move-object/from16 v20, v0
 
     iget-object v0, v6, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mSpec:Landroid/security/keystore/KeyGenParameterSpec;
@@ -6661,7 +6643,7 @@
     const/4 v12, 0x0
 
     :try_start_19
-    invoke-direct {v7, v6, v11, v12, v0}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+    invoke-direct {v7, v6, v12, v0}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
 
     invoke-virtual {v3, v7}, Lcom/samsung/android/security/keystore/AttestationUtils;->generateKeyPair(Lcom/samsung/android/security/keystore/AttestParameterSpec;)Ljava/security/KeyPair;
 
diff --git a/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec$Builder.smali b/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec$Builder.smali
index ec9258b99..85d27c8c2 100644
--- a/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec$Builder.smali
+++ b/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec$Builder.smali
@@ -8,8 +8,6 @@
 
 .field public final mSpec:Landroid/security/keystore/KeyGenParameterSpec;
 
-.field public mVerifiableIntegrity:Z
-
 
 # direct methods
 .method public constructor <init>(Ljava/lang/String;[B)V
@@ -17,10 +15,6 @@
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    const/4 v0, 0x0
-
-    iput-boolean v0, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec$Builder;->mVerifiableIntegrity:Z
-
     invoke-virtual {p1}, Ljava/lang/String;->isEmpty()Z
 
     move-result v0
diff --git a/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec.smali b/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec.smali
index e2e2e3466..bf1404aa9 100644
--- a/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec.smali
+++ b/smali_classes2/com/samsung/android/security/keystore/AttestParameterSpec.smali
@@ -12,11 +12,9 @@
 
 .field public final mSpec:Landroid/security/keystore/KeyGenParameterSpec;
 
-.field public final mVerifiableIntegrity:Z
-
 
 # direct methods
-.method public constructor <init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+.method public constructor <init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
     .locals 2
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
@@ -53,11 +51,9 @@
     :goto_1
     iput-object p1, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mChallenge:[B
 
-    iput-boolean p2, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mVerifiableIntegrity:Z
-
-    iput-boolean p3, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mSAKUidRequired:Z
+    iput-boolean p2, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mSAKUidRequired:Z
 
-    iput-object p4, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mSpec:Landroid/security/keystore/KeyGenParameterSpec;
+    iput-object p3, p0, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mSpec:Landroid/security/keystore/KeyGenParameterSpec;
 
     return-void
 .end method
diff --git a/smali_classes2/com/samsung/android/security/keystore/AttestationUtils.smali b/smali_classes2/com/samsung/android/security/keystore/AttestationUtils.smali
index 52f1be739..68f72cb88 100644
--- a/smali_classes2/com/samsung/android/security/keystore/AttestationUtils.smali
+++ b/smali_classes2/com/samsung/android/security/keystore/AttestationUtils.smali
@@ -326,11 +326,11 @@
 
     move-result v0
 
-    if-nez v0, :cond_d
+    if-nez v0, :cond_c
 
     iget-object v0, p1, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mChallenge:[B
 
-    if-eqz v0, :cond_c
+    if-eqz v0, :cond_b
 
     new-instance v1, Ljava/util/ArrayList;
 
@@ -360,12 +360,8 @@
 
     invoke-virtual {v1, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    iget-boolean v0, p1, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mVerifiableIntegrity:Z
-
     const-string v2, "AttestationUtils"
 
-    if-eqz v0, :cond_9
-
     const v0, 0x700008fe
 
     invoke-static {v0}, Lcom/samsung/android/security/keystore/AttestationUtils;->makeBool(I)Landroid/hardware/security/keymint/KeyParameter;
@@ -648,11 +644,10 @@
 
     invoke-static {v2, v0}, Landroid/util/Log;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    :cond_9
     :goto_5
     iget-boolean v0, p1, Lcom/samsung/android/security/keystore/AttestParameterSpec;->mSAKUidRequired:Z
 
-    if-eqz v0, :cond_b
+    if-eqz v0, :cond_a
 
     const-string/jumbo v0, "constructAttestationArguments : set SAK UID required"
 
@@ -676,7 +671,7 @@
 
     move-result v0
 
-    if-nez v0, :cond_a
+    if-nez v0, :cond_9
 
     const-string/jumbo v0, "constructAttestationArguments : setSAKUidRequired API does not be supported in this model. This API is supported only in JDM models and the first API level needs to be higher than 34."
 
@@ -684,7 +679,7 @@
 
     goto :goto_6
 
-    :cond_a
+    :cond_9
     const v0, 0x700009c4
 
     invoke-static {v0}, Lcom/samsung/android/security/keystore/AttestationUtils;->makeBool(I)Landroid/hardware/security/keymint/KeyParameter;
@@ -693,7 +688,7 @@
 
     invoke-virtual {v1, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    :cond_b
+    :cond_a
     :goto_6
     invoke-virtual {v1}, Ljava/util/ArrayList;->size()I
 
@@ -747,7 +742,7 @@
 
     throw p1
 
-    :cond_c
+    :cond_b
     new-instance p0, Ljava/lang/IllegalArgumentException;
 
     const-string/jumbo p1, "constructAttestationArguments : The challenge cannot be null"
@@ -756,7 +751,7 @@
 
     throw p0
 
-    :cond_d
+    :cond_c
     new-instance p0, Ljava/lang/NullPointerException;
 
     const-string/jumbo p1, "constructAttestationArguments : alias == null"
@@ -889,7 +884,7 @@
 
     const/4 v1, 0x0
 
-    invoke-direct {v0, p2, v1, v1, p1}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+    invoke-direct {v0, p2, v1, p1}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
 
     invoke-virtual {p0, v0}, Lcom/samsung/android/security/keystore/AttestationUtils;->generateKeyPair(Lcom/samsung/android/security/keystore/AttestParameterSpec;)Ljava/security/KeyPair;
 
diff --git a/smali_classes2/com/samsung/android/ssdid/SemSsdidManagerService.smali b/smali_classes2/com/samsung/android/ssdid/SemSsdidManagerService.smali
index 0b051f278..1e3f7f9c0 100644
--- a/smali_classes2/com/samsung/android/ssdid/SemSsdidManagerService.smali
+++ b/smali_classes2/com/samsung/android/ssdid/SemSsdidManagerService.smali
@@ -197,7 +197,7 @@
 
     new-instance v11, Lcom/samsung/android/security/keystore/AttestParameterSpec;
 
-    invoke-direct {v11, v0, v7, v12, v8}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZZLandroid/security/keystore/KeyGenParameterSpec;)V
+    invoke-direct {v11, v0, v12, v8}, Lcom/samsung/android/security/keystore/AttestParameterSpec;-><init>([BZLandroid/security/keystore/KeyGenParameterSpec;)V
 
     invoke-virtual {v6, v11}, Lcom/samsung/android/security/keystore/AttestationUtils;->generateKeyPair(Lcom/samsung/android/security/keystore/AttestParameterSpec;)Ljava/security/KeyPair;
 
-- 
2.51.0

