From ae3734e064811df1974114ba164911e621a77c85 Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Sun, 5 Oct 2025 22:46:03 +0200
Subject: [PATCH] Disable SAK in DarManagerService

UN1CA: this patch is not complete! Please check unica/mods/knoxpatch/customize.sh for more info.
---
 .../server/enterprise/EDMProxyService.smali   | 16 -----
 .../certificate/CertificatePolicy.smali       | 14 ----
 .../server/knox/dar/DarManagerService.smali   | 66 +------------------
 3 files changed, 1 insertion(+), 95 deletions(-)

diff --git a/smali/com/android/server/enterprise/EDMProxyService.smali b/smali/com/android/server/enterprise/EDMProxyService.smali
index bcc14d89a..e7644b191 100644
--- a/smali/com/android/server/enterprise/EDMProxyService.smali
+++ b/smali/com/android/server/enterprise/EDMProxyService.smali
@@ -1620,22 +1620,6 @@
     goto :goto_1
 
     :cond_5
-    iget-object p0, v1, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
-
-    new-array p1, v3, [Ljava/security/cert/Certificate;
-
-    invoke-interface {v4, p1}, Ljava/util/List;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
-
-    move-result-object p1
-
-    check-cast p1, [Ljava/security/cert/Certificate;
-
-    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/DarManagerService;->checkDeviceIntegrity([Ljava/security/cert/Certificate;)Z
-
-    move-result p0
-
-    if-eqz p0, :cond_6
-
     return v2
 
     :cond_6
diff --git a/smali/com/android/server/enterprise/certificate/CertificatePolicy.smali b/smali/com/android/server/enterprise/certificate/CertificatePolicy.smali
index 32a9c6ee5..2b8358afa 100644
--- a/smali/com/android/server/enterprise/certificate/CertificatePolicy.smali
+++ b/smali/com/android/server/enterprise/certificate/CertificatePolicy.smali
@@ -17,8 +17,6 @@
 
 .field public final mContext:Landroid/content/Context;
 
-.field public final mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
-
 .field public mEDM:Lcom/samsung/android/knox/EnterpriseDeviceManager;
 
 .field public final mEdmStorageProvider:Lcom/android/server/enterprise/storage/EdmStorageProvider;
@@ -366,8 +364,6 @@
 
     iput-object v1, p0, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mCertStore:Lcom/android/org/conscrypt/TrustedCertificateStore;
 
-    iput-object v0, p0, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
-
     new-instance v0, Lcom/android/server/enterprise/certificate/CertificatePolicy$1;
 
     invoke-direct {v0}, Ljava/lang/ThreadLocal;-><init>()V
@@ -584,16 +580,6 @@
 
     iput-object p1, p0, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mEnterpriseDumpHelper:Lcom/android/server/enterprise/utils/EnterpriseDumpHelper;
 
-    const-string/jumbo p1, "dar"
-
-    invoke-static {p1}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
-
-    move-result-object p1
-
-    check-cast p1, Lcom/android/server/knox/dar/DarManagerService;
-
-    iput-object p1, p0, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
-
     iget-object p1, p0, Lcom/android/server/enterprise/certificate/CertificatePolicy;->mContext:Landroid/content/Context;
 
     const-string/jumbo v0, "user"
diff --git a/smali/com/android/server/knox/dar/DarManagerService.smali b/smali/com/android/server/knox/dar/DarManagerService.smali
index a9e973951..04b46463a 100644
--- a/smali/com/android/server/knox/dar/DarManagerService.smali
+++ b/smali/com/android/server/knox/dar/DarManagerService.smali
@@ -1387,62 +1387,6 @@
     return p0
 .end method
 
-.method public final checkDeviceIntegrity([Ljava/security/cert/Certificate;)Z
-    .locals 3
-
-    const/4 v0, 0x0
-
-    aget-object p1, p1, v0
-
-    check-cast p1, Ljava/security/cert/X509Certificate;
-
-    :try_start_0
-    new-instance v1, Lcom/android/server/knox/dar/AttestedCertParser;
-
-    invoke-direct {v1, p1}, Lcom/android/server/knox/dar/AttestedCertParser;-><init>(Ljava/security/cert/X509Certificate;)V
-
-    iget-object p1, v1, Lcom/android/server/knox/dar/AttestedCertParser;->mKnoxIngetrity:Lcom/android/server/knox/dar/IntegrityStatus;
-
-    const/4 v1, 0x1
-
-    if-eqz p1, :cond_0
-
-    iget v2, p1, Lcom/android/server/knox/dar/IntegrityStatus;->mWarranty:I
-
-    if-nez v2, :cond_0
-
-    iget p1, p1, Lcom/android/server/knox/dar/IntegrityStatus;->mTrustBoot:I
-
-    if-nez p1, :cond_0
-
-    return v1
-
-    :cond_0
-    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->isEmTokenAllowed()Z
-
-    move-result p0
-
-    if-eqz p0, :cond_1
-
-    const-string p0, "DarManagerService"
-
-    const-string p1, "Failed in device integrity check. But, EM Token is allowed. Continue - "
-
-    invoke-static {p0, p1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_0
-    .catch Ljava/security/cert/CertificateParsingException; {:try_start_0 .. :try_end_0} :catch_0
-
-    return v1
-
-    :catch_0
-    move-exception p0
-
-    invoke-virtual {p0}, Ljava/security/cert/CertificateParsingException;->printStackTrace()V
-
-    :cond_1
-    return v0
-.end method
-
 .method public final checkSystemPermission()V
     .locals 3
 
@@ -3991,15 +3935,7 @@
 
     if-eqz v2, :cond_1
 
-    invoke-static {v0}, Lcom/samsung/android/security/keystore/AttestationUtils;->getCertificateChain(Ljava/lang/String;)[Ljava/security/cert/Certificate;
-
-    move-result-object v2
-
-    invoke-virtual {p0, v2}, Lcom/android/server/knox/dar/DarManagerService;->checkDeviceIntegrity([Ljava/security/cert/Certificate;)Z
-
-    move-result v1
-
-    if-eqz v1, :cond_1
+    const/4 v1, 0x1
 
     invoke-static {v0}, Lcom/samsung/android/security/keystore/AttestationUtils;->deleteKey(Ljava/lang/String;)V
     :try_end_0
-- 
2.51.0

